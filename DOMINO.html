<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† (CSS Variables) - Ù…Ù† Ù…Ù„Ù gasos.html
        ========================================= */
        :root {
            --bg-color: #0f172a;
            /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ§Ù…Ù‚ */
            --card-color: #1e293b;
            /* Ù„ÙˆÙ† Ø§Ù„ÙƒØ±ÙˆØª */
            --primary-color: #3b82f6;
            /* Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
            --create-btn: #8b5cf6;
            /* Ù„ÙˆÙ† Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Ø¨Ù†ÙØ³Ø¬ÙŠ) */
            --accent-color: #f43f5e;
            /* Ø§Ù„Ø£Ø­Ù…Ø± (Ù„Ù„Ø®Ø·Ø±) */
            --text-main: #f8fafc;
            /* Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø¨ÙŠØ¶ */
            --text-muted: #94a3b8;
            /* Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ */
            --highlight: #ffd700;
            /* Ù„ÙˆÙ† Ø§Ù„ØªÙ…ÙŠÙŠØ² */
            --tile-color: #f0f0f0;
            /* Ù„ÙˆÙ† Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ */
            --tile-shadow: #000;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Views Management --- */
        .view {
            display: none;
            width: 100%;
            height: 100%;
        }

        .view.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            box-sizing: border-box;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ§Ø±Øª (Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±) */
        .card {
            background-color: var(--card-color);
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
            text-align: center;
            max-width: 550px;
            width: 100%;
            box-sizing: border-box;
        }

        .lobby-container {
            width: 100%;
            max-width: 400px;
        }

        /* Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
        h1 {
            color: #60a5fa;
            margin: 0 0 10px 0;
            font-size: 32px;
            font-weight: 900;
        }

        h2 {
            margin: 0 0 15px 0;
            font-weight: 700;
            font-size: 24px;
        }

        p {
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* =========================================
           2. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Buttons Styling)
        ========================================= */
        .btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            font-family: 'Tajawal', sans-serif;
            font-weight: 800;
            font-size: 20px;
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.1s, filter 0.2s;
            text-align: center;
        }

        .btn:active {
            transform: scale(0.96);
        }

        /* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
        .btn:disabled {
            filter: grayscale(1);
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØªÙ„ÙØ© */
        .btn-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        /* Ø¯Ø®ÙˆÙ„ */
        .btn-create {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        /* Ø¥Ù†Ø´Ø§Ø¡ (Ø¨Ù†ÙØ³Ø¬ÙŠ) */
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        /* Ø®Ø±ÙˆØ¬ */
        .btn-secondary {
            background: transparent;
            border: 2px solid #334155;
            color: var(--text-muted);
            padding: 16px;
        }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        input[type="text"] {
            width: 100%;
            padding: 16px;
            margin: 10px 0;
            background-color: #0f172a;
            border: 2px solid #334155;
            border-radius: 14px;
            color: white;
            font-family: 'Tajawal', sans-serif;
            font-size: 18px;
            text-align: center;
            box-sizing: border-box;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* --- Game Layout --- */
        #game-layout {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100%;
            width: 100%;
        }

        /* Player Info Header */
        #top-bar {
            padding: 15px;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }

        .room-info {
            font-weight: bold;
            color: var(--text-main);
            font-size: 18px;
        }

        /* Opponent Hands (Top) */
        #opponents-area {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 10px;
            background: rgba(30, 41, 59, 0.5);
        }

        .opponent {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--card-color);
            padding: 5px 15px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .opponent.active {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 10px var(--accent-color);
        }

        .opponent-tiles {
            display: flex;
            margin-top: 5px;
        }

        .mini-tile {
            width: 12px;
            height: 20px;
            background: #94a3b8;
            border: 1px solid #475569;
            border-radius: 2px;
            margin: 0 1px;
        }

        /* Board */
        #board-area {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            flex: 1;
            /* Wooden texture replacement - Dark Pattern */
            background-color: #0f172a;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #board-content {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 100px;
            /* Space for expansion */
            min-width: min-content;
            transition: transform 0.3s;
        }

        /* My Hand (Bottom) */
        #bottom-area {
            padding: 15px;
            background: var(--card-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
            border-top: 1px solid #334155;
        }

        #my-hand {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            min-height: 90px;
            overflow-x: auto;
            width: 100%;
            justify-content: center;
            /* Scroll smooth */
            -webkit-overflow-scrolling: touch;
        }

        #my-hand::-webkit-scrollbar {
            height: 5px;
        }

        #my-hand::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 5px;
        }

        /* Tile Styles */
        .tile {
            width: 40px;
            height: 80px;
            background: var(--tile-color);
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.2s;
            flex-shrink: 0;
            /* Prevent shrinking in hand */
        }

        .tile::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 5px;
            right: 5px;
            height: 2px;
            background: #333;
        }

        .half {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dot {
            width: 7px;
            height: 7px;
            background: #0f172a;
            border-radius: 50%;
            position: absolute;
        }

        /* Dot Positions */
        .p1 {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .p2-tl {
            top: 20%;
            left: 20%;
        }

        .p2-tr {
            top: 20%;
            right: 20%;
        }

        .p2-bl {
            bottom: 20%;
            left: 20%;
        }

        .p2-br {
            bottom: 20%;
            right: 20%;
        }

        .p-mid-l {
            top: 50%;
            left: 20%;
            transform: translateY(-50%);
        }

        .p-mid-r {
            top: 50%;
            right: 20%;
            transform: translateY(-50%);
        }

        /* Horizontal Tile on Board */
        .tile.horizontal {
            width: 80px;
            height: 40px;
            flex-direction: row;
        }

        .tile.horizontal::after {
            top: 5px;
            bottom: 5px;
            left: 50%;
            right: auto;
            width: 2px;
            height: auto;
        }

        .tile.double-bone {
            transform: scale(0.95);
            border: 2px solid var(--primary-color);
            /* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¯ÙˆØ¨Ù„ */
        }

        /* Interaction */
        .my-hand .tile {
            cursor: pointer;
        }

        .my-hand .tile.disabled {
            filter: brightness(0.5);
            cursor: not-allowed;
            transform: none;
        }

        /* Chat overlay */
        #chat-container {
            position: absolute;
            bottom: 140px;
            right: 20px;
            width: 300px;
            height: 250px;
            background: var(--card-color);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            border: 1px solid #334155;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            transition: height 0.3s;
            z-index: 50;
        }

        #chat-container.minimized {
            height: 50px;
            overflow: hidden;
        }

        #chat-header {
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--primary-color);
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .msg {
            padding: 8px 12px;
            border-radius: 12px;
            background: #334155;
            word-wrap: break-word;
            max-width: 85%;
        }

        .msg.me {
            align-self: flex-end;
            background: var(--primary-color);
            color: white;
        }

        .msg b {
            display: block;
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 2px;
        }

        #chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #334155;
        }

        #chat-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #0f172a;
            color: white;
            font-family: inherit;
        }

        #chat-send-btn {
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 0 15px;
            margin-right: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* --- Mobile Optimization --- */
        @media (max-width: 768px) {
            .card {
                padding: 15px;
                width: 95%;
            }

            h1 {
                font-size: 24px;
            }

            .btn {
                padding: 14px;
                font-size: 16px;
            }

            input[type="text"] {
                padding: 12px;
                font-size: 16px;
            }

            #room-display {
                font-size: 14px;
            }

            #btn-start {
                padding: 8px 16px;
                font-size: 14px;
            }

            #opponents-area {
                gap: 8px;
                padding: 5px;
                flex-wrap: wrap;
            }

            .opponent {
                padding: 2px 8px;
                border-radius: 8px;
            }

            .opponent div {
                font-size: 0.8rem;
            }

            .mini-tile {
                width: 8px;
                height: 16px;
                margin: 0;
            }

            #board-content {
                padding: 50px;
            }

            /* Smaller tiles for mobile */
            .tile {
                width: 34px;
                height: 68px;
            }

            .tile.horizontal {
                width: 68px;
                height: 34px;
            }

            .dot {
                width: 5px;
                height: 5px;
            }

            .tile::after {
                height: 1px;
            }

            #bottom-area {
                padding: 10px;
            }

            #my-hand {
                min-height: 80px;
                justify-content: flex-start;
            }

            #controls {
                max-width: 100%;
            }

            #btn-draw,
            #btn-pass {
                padding: 12px;
                font-size: 14px;
                border-radius: 12px;
            }

            /* Responsive Chat */
            #chat-container {
                width: 85%;
                right: 7.5%;
                bottom: 140px;
            }

            #chat-container.minimized {
                width: 50%;
                right: 20px;
            }
        }
    </style>
</head>

<body>

    <!-- SCREEN 1: LOGIN -->
    <div id="screen-login" class="view active">
        <div class="card">
            <div style="font-size: 60px;">ğŸ²</div>
            <h1>Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ</h1>
            <p>Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¨Ø¯Ø¡</p>
            <input type="text" id="username-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" maxlength="12">
            <button class="btn btn-create" onclick="saveName()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- SCREEN 2: LOBBY -->
    <div id="screen-lobby" class="view">
        <div class="card">
            <h2 id="welcome-msg">Ø£Ù‡Ù„Ø§Ù‹</h2>

            <div style="margin: 20px 0;">
                <button onclick="createRoom()" class="btn btn-create">âœ¨ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>

            <div style="margin: 20px 0; border-top: 1px solid #334155; padding-top: 20px;">
                <p>Ø£Ùˆ Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©</p>
                <input type="text" id="room-code-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (4 Ø£Ø±Ù‚Ø§Ù…)">
                <button onclick="joinRoom()" class="btn btn-blue">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
            </div>

            <div style="margin-top: 30px;">
                <input type="text" id="display-name" style="padding: 10px; font-size: 0.9rem; width: 60%;">
                <button onclick="updateName()" class="btn btn-secondary"
                    style="width: auto; padding: 10px 20px; display: inline-block;">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button>
            </div>
        </div>
    </div>

    <!-- SCREEN 3: GAME -->
    <div id="screen-game" class="view" style="padding: 0;">
        <div id="game-layout">
            <!-- Top Bar -->
            <div id="top-bar">
                <div class="room-info" id="room-display">ØºØ±ÙØ©: ----</div>
                <button id="btn-start" class="btn btn-create"
                    style="display:none; width: auto; padding: 8px 20px; font-size: 16px; margin: 0;"
                    onclick="startGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨</button>
            </div>

            <!-- Opponents -->
            <div id="opponents-area"></div>

            <!-- Board -->
            <div id="board-area">
                <div id="board-content"></div>
            </div>

            <!-- My Hand -->
            <div id="bottom-area">
                <div id="status-msg"
                    style="color: var(--highlight); margin-bottom: 5px; font-weight: bold; font-size: 1.1rem;">Ø§Ù†ØªØ¸Ø§Ø±...
                </div>

                <div id="my-hand" class="my-hand"></div>

                <div id="controls" style="display: flex; gap: 10px; margin-top: 10px; width: 100%; max-width: 400px;">
                    <button id="btn-draw" class="btn btn-blue" onclick="drawTile()" disabled>Ø³Ø­Ø¨ (<span
                            id="market-cnt">0</span>)</button>
                    <button id="btn-pass" class="btn btn-danger" onclick="passTurn()" disabled>ØªØ®Ø·ÙŠ</button>
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div id="chat-container">
            <div id="chat-header" onclick="toggleChat()">
                <span>ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span>
                <span>â–¼</span>
            </div>
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                <button id="chat-send-btn" onclick="sendMsg()">â¤</button>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, push, child, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCp9_P3K__Sr76iKgaVG1iD4NluUqPtni4",
            authDomain: "heka-codenames.firebaseapp.com",
            projectId: "heka-codenames",
            storageBucket: "heka-codenames.firebasestorage.app",
            messagingSenderId: "901713932504",
            appId: "1:901713932504:web:b6710ddf537cd3c7c4e7ad"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Global State ---
        let myName = localStorage.getItem('domino_username') || "";
        let myId = localStorage.getItem('domino_userid');
        if (!myId) {
            myId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('domino_userid', myId);
        }
        let currentRoom = null;
        let playerList = []; // Array of {id, name, handCount, isMe}
        let myHand = [];
        let gameData = null;

        // --- DOM Elements ---
        const screens = {
            login: document.getElementById('screen-login'),
            lobby: document.getElementById('screen-lobby'),
            game: document.getElementById('screen-game')
        };

        // --- Initialization ---
        window.onload = () => {
            if (myName) {
                document.getElementById('display-name').value = myName;
                showScreen('lobby');
                document.getElementById('welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ ${myName}`;
            } else {
                showScreen('login');
            }
        };

        window.saveName = () => {
            const nameInput = document.getElementById('username-input').value.trim();
            if (nameInput) {
                myName = nameInput;
                localStorage.setItem('domino_username', myName);
                document.getElementById('welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ ${myName}`;
                document.getElementById('display-name').value = myName;
                showScreen('lobby');
            } else {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");
            }
        };

        window.updateName = () => {
            const nameInput = document.getElementById('display-name').value.trim();
            if (nameInput) {
                myName = nameInput;
                localStorage.setItem('domino_username', myName);
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…");
                // If in room, could update there too ideally
            }
        }

        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[name].classList.add('active');
        }

        // --- Lobby Logic ---

        window.createRoom = async () => {
            const roomCode = Math.floor(1000 + Math.random() * 9000).toString(); // 4 digit
            const roomRef = ref(db, `rooms/${roomCode}`);

            // Check if exists (unlikely but good practice)
            const snapshot = await get(roomRef);
            if (snapshot.exists()) return createRoom(); // retry

            const initialData = {
                status: 'waiting',
                host: myId,
                players: {
                    [myId]: { name: myName, score: 0, hand: false }
                },
                createdAt: Date.now()
            };

            await set(roomRef, initialData);
            enterRoom(roomCode);
        };

        window.joinRoom = async () => {
            const code = document.getElementById('room-code-input').value.trim();
            if (!code) return alert("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©");

            const roomRef = ref(db, `rooms/${code}`);
            const snapshot = await get(roomRef);

            if (!snapshot.exists()) return alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
            const data = snapshot.val();

            if (data.status !== 'waiting') return alert("Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„");
            if (Object.keys(data.players || {}).length >= 4) return alert("Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©");

            // Add self
            await update(child(roomRef, `players/${myId}`), {
                name: myName,
                score: 0,
                hand: false
            });

            enterRoom(code);
        };

        function enterRoom(code) {
            currentRoom = code;
            showScreen('game');
            document.getElementById('room-display').innerText = `ØºØ±ÙØ©: ${code}`;

            // Listen to Room Updates
            const roomRef = ref(db, `rooms/${code}`);

            // Remove old listeners if any by returning callback? (Simplification: reload page resets)
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    alert("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØºØ±ÙØ©");
                    location.reload();
                    return;
                }
                gameData = data;
                syncGame(data);
            });

            // Handle Disconnect
            onDisconnect(child(roomRef, `players/${myId}`)).remove();
        }

        // --- Game Logic ---

        function syncGame(data) {
            // 1. Update Player List
            const pIds = Object.keys(data.players);
            playerList = pIds.map(id => ({
                id,
                name: data.players[id].name,
                handCount: data.players[id].hand ? data.players[id].hand.length : 0,
                // Note: we can't see others hand content usually, but in Firebase basic rules everyone reads everything.
                // For UI, we filter.
                isMe: id === myId
            }));

            renderOpponents();

            // 2. Control Buttons (Start for host)
            const btnStart = document.getElementById('btn-start');
            if (data.status === 'waiting') {
                if (data.host === myId) {
                    btnStart.style.display = 'block';
                    btnStart.innerText = `Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ (${pIds.length})`;
                    btnStart.disabled = pIds.length < 2;
                } else {
                    btnStart.style.display = 'none';
                    document.getElementById('status-msg').innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„ÙŠØ¨Ø¯Ø£...";
                }
                document.getElementById('board-content').innerHTML = '';
                document.getElementById('my-hand').innerHTML = '';
            }
            else if (data.status === 'playing') {
                btnStart.style.display = 'none';

                // Render Board
                renderBoard(data.board || []);

                // Render My Hand
                const myPlayerData = data.players[myId];
                if (myPlayerData && myPlayerData.hand) {
                    myHand = myPlayerData.hand; // Array of objects
                    renderHand();
                }

                // Turn Status
                const currentPlayerId = pIds[data.turnIndex];
                const isMyTurn = currentPlayerId === myId;

                if (isMyTurn) {
                    document.getElementById('status-msg').innerText = "ğŸŸ¢ Ø¯ÙˆØ±Ùƒ!";
                    document.getElementById('board-area').style.borderColor = "#4caf50";
                    checkMyOptions(data);
                } else {
                    const currName = data.players[currentPlayerId].name;
                    document.getElementById('status-msg').innerText = `â³ Ø¯ÙˆØ± ${currName}`;
                    document.getElementById('board-area').style.borderColor = "transparent";
                    disableControls();
                }

                // Market Count
                const marketCount = data.market ? data.market.length : 0;
                document.getElementById('market-cnt').innerText = marketCount;
            }
            else if (data.status === 'finished') {
                document.getElementById('status-msg').innerText = data.winMsg || "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©";
                if (data.host === myId) {
                    btnStart.style.display = 'block';
                    btnStart.innerText = "Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
                }
            }

            // Chat Sync
            if (data.chat) {
                const chatBox = document.getElementById('chat-messages');
                chatBox.innerHTML = '';
                Object.values(data.chat).forEach(msg => {
                    const d = document.createElement('div');
                    d.className = `msg ${msg.sender === myName ? 'me' : ''}`;
                    d.innerHTML = `<b>${msg.sender}</b> ${msg.text}`;
                    chatBox.appendChild(d);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        // --- Host Starts Game ---
        window.startGame = () => {
            // Generate Deck
            const players = Object.keys(gameData.players);
            const playerCount = players.length;
            let deck = initDeck();

            // 3 Player Rule: Remove 0|0
            if (playerCount === 3) {
                deck = deck.filter(t => !(t.v1 === 0 && t.v2 === 0));
            }

            // Shuffle
            deck.sort(() => Math.random() - 0.5);

            // Distribute
            let handSize = 7;
            if (playerCount === 3) handSize = 9;

            const updates = {};
            updates[`rooms/${currentRoom}/status`] = 'playing';
            updates[`rooms/${currentRoom}/turnIndex`] = 0; // Host or random? Let's say index 0
            updates[`rooms/${currentRoom}/board`] = [];
            updates[`rooms/${currentRoom}/chainHead`] = null;
            updates[`rooms/${currentRoom}/chainTail`] = null;

            players.forEach((pid) => {
                const hand = deck.splice(0, handSize);
                updates[`rooms/${currentRoom}/players/${pid}/hand`] = hand;
            });

            // Market / Boneyard
            updates[`rooms/${currentRoom}/market`] = deck; // Remainders

            update(ref(db), updates);
        };

        // --- Gameplay Helper Functions ---

        function initDeck() {
            let d = [];
            for (let i = 0; i <= 6; i++) {
                for (let j = i; j <= 6; j++) {
                    d.push({ v1: i, v2: j });
                }
            }
            return d;
        }

        function renderOpponents() {
            const c = document.getElementById('opponents-area');
            c.innerHTML = '';
            playerList.forEach(p => {
                if (p.isMe) return;
                const div = document.createElement('div');
                div.className = 'opponent';
                if (gameData && gameData.turnIndex >= 0) {
                    const currentTurnId = Object.keys(gameData.players)[gameData.turnIndex];
                    if (p.id === currentTurnId) div.classList.add('active');
                }

                let tilesHtml = '';
                for (let i = 0; i < p.handCount; i++) tilesHtml += '<div class="mini-tile"></div>';

                div.innerHTML = `<div>${p.name}</div><div class="opponent-tiles">${tilesHtml}</div>`;
                c.appendChild(div);
            });
        }

        const dotMap = {
            0: [], 1: ['p1'], 2: ['p2-tr', 'p2-bl'], 3: ['p2-tr', 'p1', 'p2-bl'],
            4: ['p2-tl', 'p2-tr', 'p2-bl', 'p2-br'], 5: ['p2-tl', 'p2-tr', 'p1', 'p2-bl', 'p2-br'],
            6: ['p2-tl', 'p2-tr', 'p-mid-l', 'p-mid-r', 'p2-bl', 'p2-br']
        };

        function createTileDom(v1, v2, isDouble, isHorizontal) {
            const el = document.createElement('div');
            let cls = 'tile';
            if (isHorizontal && !isDouble) cls += ' horizontal';
            if (isDouble) cls += ' double-bone';
            el.className = cls;

            // Build dots... (same as before)
            const h1 = document.createElement('div'); h1.className = 'half'; addDots(h1, v1);
            const h2 = document.createElement('div'); h2.className = 'half'; addDots(h2, v2);
            el.append(h1, h2);
            return el;
        }

        function addDots(container, val) {
            dotMap[val].forEach(c => {
                const d = document.createElement('div'); d.className = 'dot ' + c;
                container.appendChild(d);
            });
        }

        function renderBoard(board) {
            const c = document.getElementById('board-content');
            c.innerHTML = '';
            board.forEach(b => {
                // b has {v1, v2, ...}
                // orientation logic is pre-calculated or needs calculate? 
                // For simplicity, we save visualV1 and visualV2 in board state or infer it.
                // Let's assume board saves visual state: {v1, v2, isHorizontal}
                const isDouble = b.v1 === b.v2;
                const el = createTileDom(b.v1, b.v2, isDouble, true); // Always horizontal on board unless double
                c.appendChild(el);
            });
        }

        function renderHand() {
            const c = document.getElementById('my-hand');
            c.innerHTML = '';
            myHand.forEach((tile, idx) => {
                const isDouble = tile.v1 === tile.v2;
                const el = createTileDom(tile.v1, tile.v2, isDouble, false);
                el.onclick = () => playTile(idx);

                // Validation highlight
                const valid = getValidMove(tile, gameData.chainHead, gameData.chainTail);
                if (!valid && gameData.status === 'playing') el.classList.add('disabled');

                c.appendChild(el);
            });
        }

        function getValidMove(tile, head, tail) {
            // First move?
            if (head === undefined || head === null) return { side: 'start', connect: 'v1' }; // Any tile valid

            // Check Head
            if (tile.v1 === head) return { side: 'head', connect: 'v1', newExposed: tile.v2 };
            if (tile.v2 === head) return { side: 'head', connect: 'v2', newExposed: tile.v1 };

            // Check Tail
            if (tile.v1 === tail) return { side: 'tail', connect: 'v1', newExposed: tile.v2 };
            if (tile.v2 === tail) return { side: 'tail', connect: 'v2', newExposed: tile.v1 };

            return null;
        }

        // --- Player Actions ---

        window.playTile = async (index) => {
            // Check local turn
            const pIds = Object.keys(gameData.players);
            if (pIds[gameData.turnIndex] !== myId) return;

            const tile = myHand[index];
            const move = getValidMove(tile, gameData.chainHead, gameData.chainTail);

            if (!move) return alert("Ø­Ø±ÙƒØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©");

            // Construct Update
            const updates = {};

            // 1. Remove from hand
            const newHand = [...myHand];
            newHand.splice(index, 1);
            updates[`rooms/${currentRoom}/players/${myId}/hand`] = newHand;

            // 2. Add to Board
            let visualV1, visualV2;
            if (move.side === 'start') {
                visualV1 = tile.v1; visualV2 = tile.v2;
                updates[`rooms/${currentRoom}/chainHead`] = tile.v1;
                updates[`rooms/${currentRoom}/chainTail`] = tile.v2;
                updates[`rooms/${currentRoom}/board`] = [{ v1: tile.v1, v2: tile.v2 }];
            }
            else if (move.side === 'tail') {
                // Append to right
                // if connect=v1, left of new tile is v1. visualV1=v1.
                if (move.connect === 'v1') { visualV1 = tile.v1; visualV2 = tile.v2; }
                else { visualV1 = tile.v2; visualV2 = tile.v1; }

                updates[`rooms/${currentRoom}/chainTail`] = move.newExposed;
                const currentBoard = gameData.board || [];
                updates[`rooms/${currentRoom}/board`] = [...currentBoard, { v1: visualV1, v2: visualV2 }];
            }
            else { // head
                // Prepend to left
                // if connect=v1, right of new tile is v1. visualV2=v1.
                if (move.connect === 'v1') { visualV1 = tile.v2; visualV2 = tile.v1; }
                else { visualV1 = tile.v1; visualV2 = tile.v2; }

                updates[`rooms/${currentRoom}/chainHead`] = move.newExposed;
                const currentBoard = gameData.board || [];
                updates[`rooms/${currentRoom}/board`] = [{ v1: visualV1, v2: visualV2 }, ...currentBoard];
            }

            // 3. Next Turn
            let nextIndex = (gameData.turnIndex + 1) % pIds.length;
            updates[`rooms/${currentRoom}/turnIndex`] = nextIndex;

            // 4. Check Win
            if (newHand.length === 0) {
                updates[`rooms/${currentRoom}/status`] = 'finished';
                updates[`rooms/${currentRoom}/winMsg`] = `ÙØ§Ø² ${myName}!`;
            }

            await update(ref(db), updates);
        };

        window.drawTile = async () => {
            if (!gameData.market || gameData.market.length === 0) return;

            const market = [...gameData.market];
            const tile = market.pop();
            const newHand = [...myHand, tile];

            const updates = {};
            updates[`rooms/${currentRoom}/market`] = market;
            updates[`rooms/${currentRoom}/players/${myId}/hand`] = newHand;

            await update(ref(db), updates);
        };

        window.passTurn = async () => {
            // Should check if really blocked
            const pIds = Object.keys(gameData.players);
            let nextIndex = (gameData.turnIndex + 1) % pIds.length;
            await update(ref(db, `rooms/${currentRoom}/turnIndex`), nextIndex);

            // TODO: Detect global block (all passed consecutively? Not implemented for simplicity)
        };

        function checkMyOptions(data) {
            const canMove = myHand.some(t => getValidMove(t, data.chainHead, data.chainTail));
            const btnDraw = document.getElementById('btn-draw');
            const btnPass = document.getElementById('btn-pass');

            // Draw button
            if (!canMove && data.market && data.market.length > 0) {
                btnDraw.disabled = false;
                // btnDraw.classList.remove('secondary'); // Style handled by disabled attr check in CSS mostly or dynamic class
                btnDraw.style.opacity = "1";
            } else {
                btnDraw.disabled = true;
                btnDraw.style.opacity = "0.5";
            }

            // Pass button
            if (!canMove && (!data.market || data.market.length === 0)) {
                btnPass.disabled = false;
                btnPass.style.opacity = "1";
            } else {
                btnPass.disabled = true;
                btnPass.style.opacity = "0.5";
            }
        }

        function disableControls() {
            document.getElementById('btn-draw').disabled = true;
            document.getElementById('btn-pass').disabled = true;
        }

        // --- Chat ---
        window.toggleChat = () => {
            document.getElementById('chat-container').classList.toggle('minimized');
        }

        window.sendMsg = () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            push(child(ref(db), `rooms/${currentRoom}/chat`), {
                sender: myName,
                text: text,
                time: Date.now()
            });
            input.value = '';
        }
    </script>
</body>

</html>
