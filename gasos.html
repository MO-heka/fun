<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ•µï¸ Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† (CSS Variables)
           Ù„Ø³Ù‡ÙˆÙ„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯
        ========================================= */
        :root {
            --bg-color: #0f172a;       /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ§Ù…Ù‚ */
            --card-color: #1e293b;     /* Ù„ÙˆÙ† Ø§Ù„ÙƒØ±ÙˆØª */
            --primary-color: #3b82f6;  /* Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
            --create-btn: #8b5cf6;     /* Ù„ÙˆÙ† Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Ø¨Ù†ÙØ³Ø¬ÙŠ) */
            --accent-color: #f43f5e;   /* Ø§Ù„Ø£Ø­Ù…Ø± (Ù„Ù„Ø®Ø·Ø± Ø£Ùˆ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³) */
            --text-main: #f8fafc;      /* Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø¨ÙŠØ¶ */
            --text-muted: #94a3b8;     /* Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ */
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 18px;
        }

        .container { width: 100%; max-width: 550px; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ§Ø±Øª (Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±) */
        .card {
            background-color: var(--card-color);
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
            margin-bottom: 20px;
            transition: transform 0.2s; /* Ø­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø© */
        }

        /* Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
        h1 { color: #60a5fa; margin: 0 0 10px 0; font-size: 32px; font-weight: 900; }
        h2 { margin: 0 0 15px 0; font-weight: 700; font-size: 24px; }
        p { color: var(--text-muted); line-height: 1.6; margin-bottom: 15px; }

        /* =========================================
           2. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Buttons Styling)
        ========================================= */
        .btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            font-family: 'Tajawal', sans-serif;
            font-weight: 800;
            font-size: 20px;
           color: rgb(241, 236, 236);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.1s, filter 0.2s;
        }
        .btn:active { transform: scale(0.96); } /* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */

        /* Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØªÙ„ÙØ© */
        .btn-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); } /* Ø¯Ø®ÙˆÙ„ */
        .btn-create { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); } /* Ø¥Ù†Ø´Ø§Ø¡ (Ø¨Ù†ÙØ³Ø¬ÙŠ) */
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); } /* Ø®Ø±ÙˆØ¬ */
        .btn-reveal { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); } /* ÙƒØ´Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        .btn-restart { background: linear-gradient(135deg, #10b981 0%, #059669 100%); } /* Ø¥Ø¹Ø§Ø¯Ø© */
        .btn-secondary { background: transparent; border: 2px solid #334155; color: var(--text-muted); }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø¤Ù‚Øª (ØµØºÙŠØ±Ø© ÙˆØ¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶) */
        .timer-btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .btn-small {
            width: auto;
            padding: 10px 20px;
            font-size: 16px;
            margin: 0;
        }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        input, select {
            width: 100%;
            padding: 16px;
            margin: 10px 0;
            background-color: #0f172a;
            border: 2px solid #334155;
            border-radius: 14px;
            color: rgb(241, 236, 236);
            font-family: 'Tajawal', sans-serif;
            font-size: 18px;
            text-align: center;
            box-sizing: border-box;
        }
        input:focus { outline: none; border-color: var(--primary-color); }

        /* Ø¥Ø®ÙØ§Ø¡ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .screen { display: none; opacity: 0; transition: opacity 0.3s; }
        .active { display: block; opacity: 1; }

        /* =========================================
           3. ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø®Ø§ØµØ©
        ========================================= */
        
        /* Ø´Ø¨ÙƒØ© Ø§Ù„ØªØµÙˆÙŠØª */
        .voting-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .vote-card {
            background: #334155;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }
        .vote-card.selected { border-color: var(--accent-color); background: #451a1a; }
        
        /* Ø¯Ø§Ø¦Ø±Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª */
        .vote-count {
            background: var(--primary-color);
             color: rgb(241, 236, 236);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: absolute;
            top: -5px; right: -5px;
        }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        #voting-results {
            margin-top:20px; padding:20px; background: #0f172a; 
            border: 2px solid #fbbf24; border-radius:15px; 
            display:none; animation: popIn 0.5s ease;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Ø§Ù„Ù…Ø¤Ù‚Øª */
        .timer-container {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid #334155;
            text-align: center; /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        }
        .timer-display { 
            font-size: 45px; 
            font-weight: 900; 
            color: #f8fafc; 
            letter-spacing: 3px; 
            line-height: 1;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* Ø­Ø±ÙƒØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
        .big-emoji { font-size: 60px; display: block; margin: 10px 0; animation: float 3s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="main-menu" class="screen active card" style="text-align: center;">
            <div style="font-size: 60px;">ğŸ•µï¸â€â™‚ï¸</div>
            <h1>Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ØŸ</h1>
            <p>ÙŠÙ„Ø§ Ø¨ÙŠÙ†Ø§</p>
            
            <button class="btn btn-blue" onclick="window.showScreen('local-setup')">ğŸ‘¥ Ù„Ø¹Ø¨ Ù…Ø­Ù„ÙŠ (Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯)</button>
            <button class="btn btn-create" onclick="window.showScreen('name-entry')">ğŸŒ Ù„Ø¹Ø¨ Ø£ÙˆÙ† Ù„Ø§ÙŠÙ† (Ù…Ø¹ ØªØµÙˆÙŠØª)</button>
        </div>

        <div id="name-entry" class="screen card">
            <h2>Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ ÙŠØ§ Ø¨Ø·Ù„</h2>
            <input type="text" id="player-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." maxlength="10">
            <button class="btn btn-blue" onclick="window.submitName()">ØªÙ…ØŒ Ø§Ù„ØªØ§Ù„ÙŠ</button>
            <button class="btn btn-secondary" onclick="window.showScreen('main-menu')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <div id="online-menu" class="screen card">
            <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="display-player-name" style="color:var(--primary-color)"></span></h2>
            
            <button class="btn btn-create" onclick="window.createRoom()">âœ¨ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            
            <div style="margin: 20px 0; border-top: 1px solid #334155;"></div>
            
            <input type="text" id="room-code-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (4 Ø£Ø±Ù‚Ø§Ù…)">
            <button class="btn btn-blue" onclick="window.joinRoom()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©</button>
            
            <button class="btn btn-secondary" onclick="window.showScreen('name-entry')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <div id="online-lobby" class="screen card">
            <p>ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</p>
            <h1 id="display-room-code" style="letter-spacing:5px; font-size:45px; color:#fbbf24;">----</h1>
            
            <div style="background:#0f172a; padding:15px; border-radius:15px; margin-bottom:20px;">
                <p style="margin:0;">ğŸŸ¢ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù†: <span id="connected-players-list" style="color:#fff; font-weight:bold;"></span></p>
            </div>

            <div id="host-controls" style="display:none;">
                <label>â±ï¸ Ø§Ù„ÙˆÙ‚Øª (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                <input type="number" id="game-timer-input" value="5" min="1" max="15">
                <label>ğŸ•µï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³</label>
                <input type="number" id="online-spies-count" value="1" min="1">
                <label>ğŸ”¤ ØªØµÙ†ÙŠÙ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</label>
                <select id="online-category">
                    <option value="random">ğŸ² ÙƒÙˆÙƒØªÙŠÙ„ (Ø¹Ø´ÙˆØ§Ø¦ÙŠ)</option>
                    <option value="animals">ğŸ¦ Ø­ÙŠÙˆØ§Ù†Ø§Øª</option>
                    <option value="places">ğŸ•Œ Ø£Ù…Ø§ÙƒÙ†</option>
                    <option value="food">ğŸ Ø£Ø·Ø¹Ù…Ø©</option>
                    <option value="tools">ğŸ”§ Ø£Ø¯ÙˆØ§Øª</option>
                    <option value="jobs">ğŸ’¼ ÙˆØ¸Ø§Ø¦Ù</option>
                </select>
                <button class="btn btn-create" onclick="window.startOnlineGame()">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
            </div>
            
            <p id="waiting-msg">Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠØ¸Ø¨Ø· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...</p>
        </div>

        <div id="game-screen" class="screen">
            <div class="card">
                <div class="timer-container">
                    <span class="timer-label" style="color:#fbbf24;">â³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ÙƒØ´Ù</span>
                    <div id="timer-box" class="timer-display">00:00</div>
                    
                    <div id="host-timer-controls" class="timer-btn-group" style="display:none;">
                        <button class="btn btn-blue btn-small" onclick="window.controlTimer('pause')">â¸ Ø¥ÙŠÙ‚Ø§Ù</button>
                        <button class="btn btn-create btn-small" onclick="window.controlTimer('resume')">â–¶ Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
                    </div>
                </div>

                <div style="text-align:center;">
                    <span id="my-emoji" class="big-emoji"></span>
                    <h2 id="my-role" style="font-size:28px;">...</h2>
                    <p id="my-word" style="font-weight:bold; font-size:20px; color:#34d399;">...</p>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ—³ï¸ Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ØŸ</h3>
                <p style="font-size:14px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø§ØªÙ‡Ø§Ù…Ù‡</p>
                <div id="voting-area" class="voting-grid"></div>
                
                <div id="voting-results">
                    <h3 style="color:#fbbf24; margin-top:0;">ğŸŒŸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</h3>
                    <p id="spy-identity-reveal" style="font-size:18px; color:#f43f5e; font-weight:bold;"></p>
                    <hr style="border-color:#334155;">
                    <p id="result-text" style="color:white; font-weight:bold; font-size:16px;"></p>
                </div>

                <div id="host-game-controls" style="display:none; margin-top:20px;">
                    <button class="btn btn-reveal" onclick="window.revealResultsNow()">ğŸ›‘ ÙƒØ´Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
                    <button class="btn btn-restart" onclick="window.startOnlineGame()">ğŸ”„ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                </div>
                
                <button class="btn btn-danger" onclick="location.reload()" style="margin-top:20px;">Ø®Ø±ÙˆØ¬ Ù†Ù‡Ø§Ø¦ÙŠ</button>
            </div>
        </div>

        <div id="local-setup" class="screen card">
            <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠ</h2>
            <input type="number" id="local-players-count" value="4" min="3">
            <input type="number" id="local-spies-count" value="1" min="1">
            <select id="local-category">
                <option value="random">ğŸ² ÙƒÙˆÙƒØªÙŠÙ„</option>
                <option value="animals">ğŸ¦ Ø­ÙŠÙˆØ§Ù†Ø§Øª</option>
                <option value="places">ğŸ•Œ Ø£Ù…Ø§ÙƒÙ†</option>
                <option value="food">ğŸ Ø£Ø·Ø¹Ù…Ø©</option>
                <option value="tools">ğŸ”§ Ø£Ø¯ÙˆØ§Øª</option>
                <option value="jobs">ğŸ’¼ ÙˆØ¸Ø§Ø¦Ù</option>
            </select>
            <button class="btn btn-blue" onclick="window.startLocalGame()">Ø§Ø¨Ø¯Ø£</button>
            <button class="btn btn-secondary" onclick="window.showScreen('main-menu')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <div id="local-reveal" class="screen card" style="text-align:center;">
            <h2 id="player-turn-text">Ø§Ù„Ù„Ø§Ø¹Ø¨ 1</h2>
            <p>Ø§Ø¶ØºØ· Ù„Ù„ÙƒØ´Ù</p>
            <button class="btn btn-blue" onclick="window.revealRole()" id="reveal-btn">ğŸ‘ï¸ Ø§ÙƒØ´Ù</button>
            <div id="role-content" style="display:none;">
                <span id="local-emoji" class="big-emoji"></span>
                <p id="role-text" style="font-size:24px; font-weight:bold;"></p>
                <p id="secret-word-display" style="font-size:20px; color:#fbbf24;"></p>
                <button class="btn btn-blue" onclick="window.nextPlayer()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
        </div>

    </div>

    <script type="module">
        // 1. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯ÙˆØ§Ù„ Firebase Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, onDisconnect } 
        from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Firebase Config)
        const firebaseConfig = {
            apiKey: "AIzaSyCp9_P3K__Sr76iKgaVG1iD4NluUqPtni4",
            authDomain: "heka-codenames.firebaseapp.com",
            databaseURL: "https://heka-codenames-default-rtdb.firebaseio.com",
            projectId: "heka-codenames",
            storageBucket: "heka-codenames.firebasestorage.app",
            messagingSenderId: "901713932504",
            appId: "1:901713932504:web:b6710ddf537cd3c7c4e7ad",
            measurementId: "G-TSSGCQ1CED"
        };

        // 3. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 4. Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù‡Ù†Ø§)
        const wordsData = {
            animals: [
        {t:"Ø£Ø³Ø¯",e:"ğŸ¦"},{t:"ÙÙŠÙ„",e:"ğŸ˜"},{t:"Ø¨Ø·Ø±ÙŠÙ‚",e:"ğŸ§"},{t:"Ù‚Ø±Ø´",e:"ğŸ¦ˆ"},
        {t:"ØµÙ‚Ø±",e:"ğŸ¦…"},{t:"Ù†Ù…Ù„Ø©",e:"ğŸœ"},{t:"Ù‚Ø·Ø©",e:"ğŸˆ"}, {t:"ÙƒÙ„Ø¨",e:"ğŸ•"}, {t:"Ø­ØµØ§Ù†",e:"ğŸ"},{t:"Ù‚Ø±Ø¯",e:"ğŸ’"},{t:"Ø°Ø¦Ø¨",e:"ğŸº"},{t:"Ø«Ø¹Ù„Ø¨",e:"ğŸ¦Š"},
        {t:"Ø£Ø±Ù†Ø¨",e:"ğŸ‡"},{t:"Ø¯Ø¨",e:"ğŸ»"},{t:"Ø¨Ø§Ù†Ø¯Ø§",e:"ğŸ¼"},{t:"ÙƒØ§Ù†Ø¬Ø±Ùˆ",e:"ğŸ¦˜"},{t:"ØªÙ…Ø³Ø§Ø­",e:"ğŸŠ"},{t:"Ø­ÙˆØª",e:"ğŸ‹"},{t:"Ø¯ÙˆÙ„ÙÙŠÙ†",e:"ğŸ¬"},{t:"ÙØ±Ø§Ø´Ø©",e:"ğŸ¦‹"},{t:"Ù†Ø­Ù„Ø©",e:"ğŸ"},
    ],


            places: [
        {t:"Ù…Ø¯Ø±Ø³Ø©",e:"ğŸ«"},{t:"Ø³Ø¬Ù†",e:"ğŸ‘®"},{t:"Ù…Ø³ØªØ´ÙÙ‰",e:"ğŸ¥"},
        {t:"Ù…Ø·Ø§Ø±",e:"âœˆï¸"},{t:"ÙØ¶Ø§Ø¡",e:"ğŸš€"},{t:"Ø³ÙŠÙ†Ù…Ø§",e:"ğŸ¿"},
        {t:"Ù…Ø·Ø¹Ù…",e:"ğŸ”"},{t:"Ù…Ù†Ø²Ù„",e:"ğŸ "},{t:"Ù…Ø³Ø¬Ø¯",e:"ğŸ•Œ"},{t:"ÙƒÙ†ÙŠØ³Ø©",e:"â›ª"},{t:"Ø¨Ù†Ùƒ",e:"ğŸ¦"},{t:"Ù…ÙƒØªØ¨Ø©",e:"ğŸ“š"},{t:"Ø³ÙˆÙ‚",e:"ğŸ›’"},{t:"Ø­Ø¯ÙŠÙ‚Ø©",e:"ğŸŒ³"},{t:"Ø´Ø§Ø·Ø¦",e:"ğŸ–ï¸"},{t:"Ø¬Ø¨Ù„",e:"â›°ï¸"},{t:"ØµØ­Ø±Ø§Ø¡",e:"ğŸœï¸"},{t:"ØºØ§Ø¨Ø©",e:"ğŸŒ²"},{t:"ÙÙ†Ø¯Ù‚",e:"ğŸ¨"},{t:"Ù…ØªØ­Ù",e:"ğŸ–¼ï¸"},{t:"Ù…Ù„Ø¹Ø¨",e:"ğŸŸï¸"},{t:"Ù…ØµÙ†Ø¹",e:"ğŸ­"},{t:"Ù…ÙŠÙ†Ø§Ø¡",e:"âš“"},

    ],

            food: [
                {t:"ØªÙØ§Ø­",e:"ğŸ"},{t:"Ù…ÙˆØ²",e:"ğŸŒ"},{t:"Ø¹Ù†Ø¨",e:"ğŸ‡"},{t:"Ø¨Ø·ÙŠØ®",e:"ğŸ‰"},
                {t:"Ø¨Ø±ØªÙ‚Ø§Ù„",e:"ğŸŠ"},{t:"ÙØ±Ø§ÙˆÙ„Ø©",e:"ğŸ“"},{t:"Ù…Ø§Ù†Ø¬Ùˆ",e:"ğŸ¥­"},
                {t:"Ø£Ù†Ø§Ù†Ø§Ø³",e:"ğŸ"},{t:"Ù„ÙŠÙ…ÙˆÙ†",e:"ğŸ‹"},{t:"ÙƒØ±Ø²",e:"ï¿½"},
                {t:"Ø¨ÙŠØªØ²Ø§",e:"ğŸ•"},{t:"Ø¨Ø±Ø¬Ø±",e:"ï¿½ğŸ”"},{t:"Ø¨Ø·Ø§Ø·Ø³ Ù…Ù‚Ù„ÙŠØ©",e:"ğŸŸ"},
                {t:"Ø³ÙˆØ´ÙŠ",e:"ğŸ£"},{t:"ØªØ§ÙƒÙˆ",e:"ğŸŒ®"},{t:"Ø®Ø¨Ø²",e:"ğŸ"},
                {t:"Ø¬Ø¨Ù†Ø©",e:"ğŸ§€"},{t:"Ø¨ÙŠØ¶",e:"ğŸ¥š"},{t:"Ù„Ø­Ù…",e:"ğŸ¥©"},
                {t:"Ø¯Ø¬Ø§Ø¬",e:"ğŸ—"},{t:"ÙƒÙŠÙƒ",e:"ğŸ°"},{t:"Ø¯ÙˆÙ†Ø§Øª",e:"ğŸ©"},
                {t:"Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©",e:"ğŸ«"},{t:"Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ…",e:"ğŸ¦"},{t:"Ø¹Ø³Ù„",e:"ğŸ¯"}
            ],

            tools: [
                {t:"Ù…Ø·Ø±Ù‚Ø©",e:"ğŸ”¨"},{t:"Ù…ÙÙƒ",e:"ğŸ”§"},{t:"Ù…ÙØªØ§Ø­",e:"ğŸ”‘"},
                {t:"Ù…Ù‚Øµ",e:"âœ‚ï¸"},{t:"Ù…Ù†Ø´Ø§Ø±",e:"ğŸªš"},{t:"ÙØ£Ø³",e:"ğŸª“"},
                {t:"Ù…ØµØ¨Ø§Ø­",e:"ğŸ’¡"},{t:"Ù‚ÙÙ„",e:"ğŸ”’"},{t:"Ø¨Ø·Ø§Ø±ÙŠØ©",e:"ğŸ”‹"},
                {t:"Ø´Ø§Ø­Ù†",e:"ğŸ”Œ"},{t:"ÙƒØ§Ù…ÙŠØ±Ø§",e:"ğŸ“·"},{t:"Ù‡Ø§ØªÙ",e:"ğŸ“±"},
                {t:"ÙƒÙ…Ø¨ÙŠÙˆØªØ±",e:"ğŸ’»"},{t:"Ø³Ù…Ø§Ø¹Ø§Øª",e:"ğŸ§"},{t:"Ø³Ø§Ø¹Ø©",e:"âŒš"},
                {t:"Ù‚Ù„Ù…",e:"âœï¸"},{t:"ÙƒØªØ§Ø¨",e:"ğŸ“–"},{t:"Ø´Ù†Ø·Ø©",e:"ğŸ’"},
                {t:"Ù…ØºÙ†Ø§Ø·ÙŠØ³",e:"ğŸ§²"},{t:"Ù…Ø³Ù…Ø§Ø±",e:"ğŸ“"},{t:"Ù…ÙƒÙ†Ø³Ø©",e:"ğŸ§¹"},
                {t:"ØºØ³Ø§Ù„Ø©",e:"ğŸ§º"},{t:"Ù…Ø±ÙˆØ­Ø©",e:"ğŸŒ€"},{t:"ØµØ§ÙØ±Ø©",e:"ğŸ“£"},
                {t:"Ø·Ø¨Ù„Ø©",e:"ğŸ¥"}
            ],

            jobs: [
                {t:"Ø·Ø¨ÙŠØ¨",e:"ğŸ‘¨â€âš•ï¸"},{t:"Ù…Ù‡Ù†Ø¯Ø³",e:"ğŸ‘·"},{t:"Ù…Ø¹Ù„Ù…",e:"ğŸ‘¨â€ğŸ«"},
                {t:"Ø´Ø±Ø·ÙŠ",e:"ğŸ‘®"},{t:"Ø·Ø¨Ø§Ø®",e:"ğŸ‘¨â€ğŸ³"},{t:"Ø·ÙŠØ§Ø±",e:"ğŸ‘¨â€âœˆï¸"},
                {t:"Ù…Ø²Ø§Ø±Ø¹",e:"ğŸ‘¨â€ğŸŒ¾"},{t:"ÙÙ†Ø§Ù†",e:"ğŸ‘¨â€ğŸ¨"},{t:"Ù…ØºÙ†ÙŠ",e:"ğŸ‘¨â€ğŸ¤"},
                {t:"Ù…Ø­Ø§Ù…ÙŠ",e:"ğŸ‘¨â€âš–ï¸"},{t:"Ù‚Ø§Ø¶ÙŠ",e:"âš–ï¸"},{t:"Ø¨Ø­Ø§Ø±",e:"âš“"},
                {t:"Ù‡ÙƒØ±",e:"ğŸ‘¨â€ğŸ’»"},{t:"Ø±Ø§Ø¦Ø¯ ÙØ¶Ø§Ø¡",e:"ğŸ‘¨â€ğŸš€"},
                {t:"Ø¹Ø§Ù„Ù…",e:"ğŸ‘¨â€ğŸ”¬"},{t:"Ù…ØµÙˆØ±",e:"ğŸ“¸"},
                {t:"ØµØ­ÙÙŠ",e:"ğŸ“°"},{t:"Ø³Ø§Ø¦Ù‚",e:"ğŸš—"},
                {t:"Ù†Ø¬Ø§Ø±",e:"ğŸªš"},{t:"Ø­Ø¯Ø§Ø¯",e:"âš’ï¸"},
                {t:"ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ",e:"ğŸ’¡"},{t:"Ø³Ø¨Ø§Ùƒ",e:"ğŸš¿"},
                {t:"Ø¨Ø§Ø¦Ø¹",e:"ğŸ›’"},{t:"Ø­Ø§Ø±Ø³",e:"ğŸ›¡ï¸"},
                {t:"Ù…ØªØ±Ø¬Ù…",e:"ğŸŒ"}
            ]
        };

        // 5. Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        let myName = "";
        let currentRoomId = null;
        let myPlayerId = null;
        let isHost = false; // Ù‡Ù„ Ø£Ù†Ø§ Ø§Ù„Ù…Ø¶ÙŠÙØŸ
        let timerInterval = null; // Ù…Ø±Ø¬Ø¹ Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ
        let localPlayers = [];
        let currentPlayerIndex = 0;

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        
        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ù…Ø­Ø¯Ø¯Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            setTimeout(() => document.getElementById(id).classList.add('active'), 100);
        };

        // Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ„Ù…Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„ØªØµÙ†ÙŠÙ
        function getRandomWord(cat) {
            let keys = cat === 'random' ? Object.keys(wordsData) : [cat];
            let list = wordsData[keys[Math.floor(Math.random() * keys.length)]];
            return list[Math.floor(Math.random() * list.length)];
        }

        // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
        window.submitName = () => {
            const name = document.getElementById('player-name').value.trim();
            if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø£ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
            myName = name;
            document.getElementById('display-player-name').innerText = name;
            window.showScreen('online-menu');
        };

        // ============================================
        // Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯)
        // ============================================
        window.startLocalGame = () => {
            const count = parseInt(document.getElementById('local-players-count').value);
            const spies = parseInt(document.getElementById('local-spies-count').value);
            const cat = document.getElementById('local-category').value;
            
            if (spies >= count) return alert("Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³ Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„!");

            const w = getRandomWord(cat);
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            let roles = Array(count).fill({ role: "citizen", w: w.t, e: w.e });
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³
            for(let i=0; i<spies; i++) roles[i] = { role: "spy", w: "ØŸØŸØŸ", e: "ğŸ•µï¸" };
            // Ø®Ù„Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
            roles.sort(() => Math.random() - 0.5);
            
            localPlayers = roles;
            currentPlayerIndex = 0;
            window.showScreen('local-reveal');
            updateLocalUI();
        };

        function updateLocalUI() {
            document.getElementById('player-turn-text').innerText = `Ø§Ù„Ù„Ø§Ø¹Ø¨ ${currentPlayerIndex+1}`;
            document.getElementById('reveal-btn').style.display = 'block';
            document.getElementById('role-content').style.display = 'none';
        }

        window.revealRole = () => {
            const p = localPlayers[currentPlayerIndex];
            const isSpy = p.role === "spy";
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
            document.getElementById('local-emoji').innerText = p.e;
            document.getElementById('role-text').innerText = isSpy ? "Ø£Ù†Øª Ø§Ù„Ø¬Ø§Ø³ÙˆØ³!" : "Ø£Ù†Øª Ù„Ù…Ù‘Ø§Ø­ ğŸ˜";
            document.getElementById('role-text').style.color = isSpy ? "#f43f5e" : "#34d399";
            document.getElementById('secret-word-display').innerText = isSpy ? "Ù…Ù‡Ù…ØªÙƒ: Ø§Ø¹Ø±Ù Ø§Ù„ÙƒÙ„Ù…Ø©" : `Ø§Ù„ÙƒÙ„Ù…Ø©: ${p.w}`;
            
            document.getElementById('reveal-btn').style.display = 'none';
            document.getElementById('role-content').style.display = 'block';
        };

        window.nextPlayer = () => {
            currentPlayerIndex++;
            if (currentPlayerIndex < localPlayers.length) updateLocalUI();
            else { alert("Ø§Ø¨Ø¯Ø£ÙˆØ§ Ø§Ù„Ù„Ø¹Ø¨!"); window.showScreen('main-menu'); }
        };

        // ============================================
        // Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ù„Ø¹Ø¨ Ø£ÙˆÙ† Ù„Ø§ÙŠÙ† (Firebase)
        // ============================================

        // 1. Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
        window.createRoom = () => {
            if (!myName) return alert("Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
            const roomId = Math.floor(1000 + Math.random()*9000).toString(); // ÙƒÙˆØ¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…
            myPlayerId = "host_" + Date.now();
            isHost = true;

            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            set(ref(db, `grooms/${roomId}`), {
                status: "waiting", // Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù†ØªØ¸Ø§Ø±
                timerStatus: "stopped", // Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚Øª
                players: { [myPlayerId]: { name: myName, vote: "" } }
            });
            // Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
            onDisconnect(ref(db, `grooms/${roomId}/players/${myPlayerId}`)).remove();
            enterLobby(roomId);
        };

        // 2. Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©
        window.joinRoom = () => {
            if (!myName) return alert("Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
            const roomId = document.getElementById('room-code-input').value;
            if (!roomId) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯");
            myPlayerId = "player_" + Date.now();
            isHost = false;
            
            get(ref(db, `grooms/${roomId}`)).then(snap => {
                if (snap.exists()) {
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù„ØºØ±ÙØ©
                    update(ref(db, `grooms/${roomId}/players/${myPlayerId}`), { name: myName, vote: "" });
                    onDisconnect(ref(db, `grooms/${roomId}/players/${myPlayerId}`)).remove();
                    enterLobby(roomId);
                } else alert("ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
            });
        };

        // 3. Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„ÙˆØ¨ÙŠ ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        function enterLobby(roomId) {
            currentRoomId = roomId;
            window.showScreen('online-lobby');
            document.getElementById('display-room-code').innerText = roomId;
            
            // Ø¥Ø¸Ù‡Ø§Ø± ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¶ÙŠÙ ÙÙ‚Ø· Ù„Ù„Ù…Ø¶ÙŠÙ
            document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
            document.getElementById('waiting-msg').style.display = isHost ? 'none' : 'block';

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ØºØ±ÙØ© (Realtime Listener)
            onValue(ref(db, `grooms/${roomId}`), (snap) => {
                const data = snap.val();
                if (!data) return;

                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
                const players = data.players || {};
                document.getElementById('connected-players-list').innerText = Object.values(players).map(p => p.name).join('ØŒ ');

                // Ø¥Ø°Ø§ Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                if (data.status === 'playing') {
                    renderGame(data);
                }
            });
        }

        // 4. Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù„Ù„Ù…Ø¶ÙŠÙ ÙÙ‚Ø·)
        window.startOnlineGame = () => {
            get(ref(db, `grooms/${currentRoomId}`)).then(snap => {
                const data = snap.val();
                const pIds = Object.keys(data.players);
                const spiesCount = parseInt(document.getElementById('online-spies-count').value);
                const minutes = parseInt(document.getElementById('game-timer-input').value);

                if (spiesCount >= pIds.length) return alert("Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†!");

                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                // Ù‚Ø±Ø§Ø¡Ø© ØªØµÙ†ÙŠÙ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø°ÙŠ ÙŠØ®ØªØ§Ø±Ù‡ Ø§Ù„Ù…Ø¶ÙŠÙ
                const cat = (document.getElementById('online-category') && document.getElementById('online-category').value) || 'random';
                const w = getRandomWord(cat);
                let roles = Array(pIds.length).fill("citizen");
                for(let i=0; i<spiesCount; i++) roles[i] = "spy";
                roles.sort(() => Math.random() - 0.5); // Ø®Ù„Ø· Ø¹Ø´ÙˆØ§Ø¦ÙŠ

                const updates = {};
                updates[`grooms/${currentRoomId}/status`] = "playing";
                updates[`grooms/${currentRoomId}/timerStatus`] = "running"; // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª
                updates[`grooms/${currentRoomId}/endTime`] = Date.now() + (minutes * 60000);
                updates[`grooms/${currentRoomId}/showResults`] = false; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬

                // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
                pIds.forEach((pid, idx) => {
                    const isSpy = roles[idx] === "spy";
                    updates[`grooms/${currentRoomId}/players/${pid}/role`] = isSpy ? "spy" : "citizen";
                    updates[`grooms/${currentRoomId}/players/${pid}/word`] = isSpy ? "ØŸØŸØŸ" : w.t;
                    updates[`grooms/${currentRoomId}/players/${pid}/emoji`] = isSpy ? "ğŸ•µï¸" : w.e;
                    updates[`grooms/${currentRoomId}/players/${pid}/vote`] = "";
                });

                // Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
                // Ø­ÙØ¸ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ© Ø£ÙŠØ¶Ø§Ù‹
                updates[`grooms/${currentRoomId}/category`] = cat;

                update(ref(db), updates);
            });
        };

        // 5. Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø¤Ù‚Øª (Ø¥ÙŠÙ‚Ø§Ù/Ø§Ø³ØªØ¦Ù†Ø§Ù) - Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¶ÙŠÙ
        window.controlTimer = (action) => {
            const roomRef = ref(db, `grooms/${currentRoomId}`);
            get(roomRef).then(snap => {
                const data = snap.val();
                if (action === 'pause' && data.timerStatus === 'running') {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙˆØ­ÙØ¸Ù‡
                    const remaining = data.endTime - Date.now();
                    update(roomRef, { 
                        timerStatus: 'paused', 
                        timeRemaining: remaining 
                    });
                } else if (action === 'resume' && data.timerStatus === 'paused') {
                    // Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    const newEndTime = Date.now() + data.timeRemaining;
                    update(roomRef, { 
                        timerStatus: 'running', 
                        endTime: newEndTime,
                        timeRemaining: null // Ù…Ø³Ø­ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
                    });
                }
            });
        };

        // Ø²Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„ÙƒØ´Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙŠØ¯ÙˆÙŠØ§Ù‹
        window.revealResultsNow = () => {
            update(ref(db, `grooms/${currentRoomId}`), { showResults: true });
        };

        // 6. Ø±Ø³Ù… Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨
        function renderGame(data) {
            window.showScreen('game-screen');
            const myData = data.players[myPlayerId];
            if (!myData) return;

            // Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ±
            const isSpy = myData.role === "spy";
            document.getElementById('my-emoji').innerText = myData.emoji;
            document.getElementById('my-role').innerText = isSpy ? "Ø£Ù†Øª Ø§Ù„Ø¬Ø§Ø³ÙˆØ³! ğŸ¤«" : "Ø£Ù†Øª Ù„Ù…Ù‘Ø§Ø­ ğŸ˜";
            document.getElementById('my-role').style.color = isSpy ? "#f43f5e" : "#34d399";
            document.getElementById('my-word').innerText = isSpy ? "Ø­Ø§ÙˆÙ„ Ù…Ø¹Ø±ÙØ© Ø§Ù„ÙƒÙ„Ù…Ø©" : `Ø§Ù„ÙƒÙ„Ù…Ø©: ${myData.word}`;
            
            // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¤Ù‚Øª
            handleTimer(data);

            // Ù„ÙˆØ­Ø© Ø§Ù„ØªØµÙˆÙŠØª
            renderVotingBoard(data.players);

            // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            checkResultsVisibility(data.players, data.showResults);

            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¶ÙŠÙ
            if (isHost) {
                document.getElementById('host-game-controls').style.display = 'block';
                document.getElementById('host-timer-controls').style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¤Ù‚Øª
            }
        }

        // 7. Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¤Ù‚Øª (Ù…Ø¹Ù‚Ø¯ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù)
        function handleTimer(data) {
            const timerEl = document.getElementById('timer-box');
            
            if (timerInterval) clearInterval(timerInterval); // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø¹Ø¯Ø§Ø¯ Ø³Ø§Ø¨Ù‚

            // Ø§Ù„Ø­Ø§Ù„Ø© 1: Ø§Ù„Ù…Ø¤Ù‚Øª Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªØ§Ù‹
            if (data.timerStatus === 'paused' && data.timeRemaining) {
                const m = Math.floor(data.timeRemaining / 60000);
                const s = Math.floor((data.timeRemaining % 60000) / 1000);
                timerEl.innerText = `${m}:${s.toString().padStart(2,'0')} â¸`; // Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆÙ‚Ù
                timerEl.style.color = "#fbbf24"; // Ù„ÙˆÙ† Ø£ØµÙØ± Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆÙ‚Ù
                return;
            }

            // Ø§Ù„Ø­Ø§Ù„Ø© 2: Ø§Ù„Ù…Ø¤Ù‚Øª ÙŠØ¹Ù…Ù„
            if (data.timerStatus === 'running') {
                timerInterval = setInterval(() => {
                    const now = Date.now();
                    const diff = data.endTime - now;
                    
                    if (diff <= 0) {
                        timerEl.innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!";
                        timerEl.style.color = "#f43f5e";
                        clearInterval(timerInterval);
                        
                        // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª ÙˆØ£Ù†Ø§ Ø§Ù„Ù…Ø¶ÙŠÙØŒ Ø§ÙƒØ´Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                        if (isHost) window.revealResultsNow();
                    } else {
                        const m = Math.floor(diff / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        timerEl.innerText = `${m}:${s.toString().padStart(2,'0')}`;
                        timerEl.style.color = "#f8fafc";
                    }
                }, 1000); // Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
            }
        }

        // 8. Ø±Ø³Ù… Ø´Ø¨ÙƒØ© Ø§Ù„ØªØµÙˆÙŠØª
        function renderVotingBoard(players) {
            const container = document.getElementById('voting-area');
            container.innerHTML = '';
            
            Object.keys(players).forEach(pid => {
                // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨
                const votesReceived = Object.values(players).filter(p => p.vote === pid).length;
                const p = players[pid];

                const btn = document.createElement('div');
                // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ selected Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Ø§ ØµÙˆØªØª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ
                btn.className = `vote-card ${players[myPlayerId].vote === pid ? 'selected' : ''}`;
                btn.innerHTML = `
                    <div style="font-weight:bold; color:white;">${p.name}</div>
                    ${votesReceived > 0 ? `<div class="vote-count">${votesReceived}</div>` : ''}
                `;
                
                // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ù„Ù„ØªØµÙˆÙŠØª
                if (pid !== myPlayerId) {
                    btn.onclick = () => update(ref(db, `grooms/${currentRoomId}/players/${myPlayerId}`), { vote: pid });
                } else {
                    btn.style.opacity = "0.6"; // ØªØºÙ…ÙŠÙ‚ Ø§Ø³Ù…ÙŠ (Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù†ÙØ³ÙŠ)
                    btn.style.cursor = "default";
                }
                container.appendChild(btn);
            });
        }

        // 9. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        function checkResultsVisibility(players, showResults) {
            const resultsDiv = document.getElementById('voting-results');
            
            if (!showResults) {
                resultsDiv.style.display = 'none';
                return;
            }

            resultsDiv.style.display = 'block';
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³
            const spies = Object.keys(players).filter(pid => players[pid].role === 'spy');
            const spyNames = spies.map(pid => players[pid].name).join(' Ùˆ ');
            
            document.getElementById('spy-identity-reveal').innerText = `Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ÙƒØ§Ù†: ${spyNames}`;

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (Ù…Ù† ØµÙˆØª Ù„Ù„Ø¬Ø§Ø³ÙˆØ³)
            let winners = [];
            Object.keys(players).forEach(pid => {
                if (players[pid].role !== 'spy' && spies.includes(players[pid].vote)) {
                    winners.push(players[pid].name);
                }
            });

            if (winners.length > 0) {
                document.getElementById('result-text').innerHTML = `ğŸŒŸ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø°ÙŠÙ† ÙƒØ´ÙÙˆØ§ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³:<br><span style="color:#34d399; font-size:20px;">${winners.join('ØŒ ')}</span>`;
            } else {
                document.getElementById('result-text').innerHTML = `âŒ Ù„Ù„Ø£Ø³ÙØŒ Ù‡Ø±Ø¨ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³! Ù„Ù… ÙŠÙƒØªØ´ÙÙ‡ Ø£Ø­Ø¯.`;
            }
        }
    </script>
</body>
</html>
