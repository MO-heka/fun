<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>⚽ XO Football</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Tajawal:wght@500;700;900&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #0f172a;
            --card-color: #1e293b;
            --primary-color: #3b82f6;
            --accent-color: #f59e0b;
            /* Gold for trophies */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --player-x: #3b82f6;
            --player-o: #ef4444;
            --grid-border: #334155;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            /* Prevent accidental selection */
        }

        body {
            font-family: 'Cairo', 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        /* Screens */
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .screen.active {
            display: block;
            opacity: 1;
        }

        /* Card Style */
        .card {
            background-color: var(--card-color);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin: 10px 0;
            font-weight: 900;
        }

        .btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: transform 0.1s;
            color: white;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-blue {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .btn-green {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-gold {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #000;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #334155;
            color: var(--text-muted);
        }

        /* Game Grid */
        .game-board-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 1fr;
            grid-template-rows: 80px 1fr 1fr 1fr;
            gap: 5px;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1/1;
            /* Square board */
        }

        .cell {
            background: var(--card-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--grid-border);
            padding: 5px;
        }

        /* Headers */
        .header-cell {
            background: #0f172a;
            color: var(--accent-color);
            font-size: 0.75rem;
            border: none;
        }

        .header-cell img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-bottom: 2px;
        }

        /* Playable Cells */
        .game-cell {
            background: #1e293b;
            cursor: pointer;
            transition: background 0.2s;
        }

        .game-cell:active {
            background: #334155;
        }

        .game-cell.taken {
            cursor: default;
        }

        .game-cell.taken-x {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--player-x);
        }

        .game-cell.taken-o {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--player-o);
        }

        .player-mark {
            font-size: 2rem;
            opacity: 0.2;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        .player-name-label {
            z-index: 1;
            font-size: 0.8rem;
            word-break: break-word;
            line-height: 1.2;
        }

        /* Timer Bar */
        .timer-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }

        .timer-fill {
            height: 100%;
            background: var(--primary-color);
            width: 100%;
            transition: width 1s linear;
        }

        .timer-text {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 5px;
        }

        .timer-warning {
            color: #ef4444;
        }

        /* Turn Indicator */
        .turn-indicator {
            display: flex;
            justify-content: space-between;
            background: var(--card-color);
            padding: 10px 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--grid-border);
        }

        .player-badge {
            padding: 5px 15px;
            border-radius: 10px;
            opacity: 0.5;
            font-weight: bold;
            transition: 0.3s;
        }

        .player-badge.active {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        .bg-x {
            background: var(--player-x);
        }

        .bg-o {
            background: var(--player-o);
        }

        /* Input Modal */
        #input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-color);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--primary-color);
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        input.game-input {
            width: 100%;
            padding: 15px;
            background: #0f172a;
            border: 2px solid var(--grid-border);
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            text-align: center;
            margin: 15px 0;
            outline: none;
        }

        input.game-input:focus {
            border-color: var(--primary-color);
        }

        /* Utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- Main Menu -->
        <!-- Update Menu Button -->
        <div id="screen-menu" class="screen active card">
            <h1 style="font-size: 4rem;">⚽❌⭕</h1>
            <h1>تحدي كورة</h1>
            <p style="color:var(--text-muted)">لعبة XO بس بمعلوماتك الكروية</p>

            <button class="btn btn-blue" onclick="startOfflineSetup()">📱 لعب محلي (Offline)</button>
            <button class="btn btn-green" onclick="showScreen('screen-online-setup')">🌍 لعب أونلاين (Online)</button>
            <button class="btn btn-secondary" onclick="alert('قول اللاعب الي تشترك فيه صفات العامود و الصف')">❓ كيفية
                اللعب</button>
        </div>

        <!-- Offline Setup -->
        <div id="screen-offline-setup" class="screen card">
            <h2>إعدادات اللعب</h2>
            <div style="margin: 20px 0;">
                <label>اللاعب الأول (X)</label>
                <input type="text" id="p1-name" class="game-input" value="اللاعب 1" placeholder="اسمك">

                <label>اللاعب الثاني (O)</label>
                <input type="text" id="p2-name" class="game-input" value="اللاعب 2" placeholder="اسم الخصم">
            </div>
            <button class="btn btn-blue" onclick="startGameOffline()">ابدأ المباراة 🚀</button>
            <button class="btn btn-secondary" onclick="showScreen('screen-menu')">رجوع</button>
        </div>

        <!-- Online Setup -->
        <div id="screen-online-setup" class="screen card">
            <h2>🌍 لعب أونلاين</h2>
            <div style="margin: 20px 0;">
                <button class="btn btn-create" onclick="createOnlineRoom()">✨ إنشاء غرفة جديدة</button>
                <div style="margin:15px; border-top:1px solid #334155"></div>
                <input type="number" id="room-code-input" class="game-input" placeholder="أدخل كود الغرفة (4 أرقام)">
                <button class="btn btn-blue" onclick="joinOnlineRoom()">انضمام للغرفة</button>
            </div>
            <button class="btn btn-secondary" onclick="showScreen('screen-menu')">رجوع</button>
        </div>

        <!-- Online Lobby -->
        <div id="screen-online-lobby" class="screen card">
            <h2 style="color:var(--accent-color)">ردهة الانتظار</h2>
            <p>شارك هذا الكود مع صديقك:</p>
            <h1 id="lobby-code" style="letter-spacing: 5px; font-size: 3rem;">----</h1>

            <div style="text-align:right; background:#0f172a; padding:15px; border-radius:10px; margin:10px 0;">
                <p>👤 اللاعب 1: <span id="lobby-p1" style="color:#3b82f6; font-weight:bold;">...</span></p>
                <p>👤 اللاعب 2: <span id="lobby-p2" style="color:#ef4444; font-weight:bold;">...</span></p>
            </div>

            <p id="lobby-status">في انتظار اللاعب الثاني...</p>
        </div>

        <!-- Chat Widget (Floating) -->
        <div id="chat-widget" class="hidden" style="position:fixed; bottom:10px; right:10px; width:300px; z-index:200;">
            <button id="chat-toggle" class="btn btn-blue"
                style="width:auto; border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center; box-shadow:0 5px 15px rgba(0,0,0,0.5);"
                onclick="toggleChat()">💬</button>

            <div id="chat-box"
                style="display:none; background:var(--card-color); border:1px solid var(--primary-color); border-radius:15px; height:350px; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
                <div
                    style="padding:10px; background:var(--primary-color); font-weight:bold; display:flex; justify-content:space-between;">
                    <span>💬 المحادثة</span>
                    <span style="cursor:pointer;" onclick="toggleChat()">❌</span>
                </div>
                <div id="chat-messages"
                    style="flex:1; padding:10px; overflow-y:auto; font-size:0.9rem; text-align:right;">
                    <!-- Messages -->
                </div>
                <div style="padding:5px; background:#0f172a; display:flex;">
                    <input type="text" id="chat-input" style="width:100%; padding:8px; border-radius:5px; border:none;"
                        placeholder="اكتب رسالة...">
                    <button onclick="sendChatMessage()"
                        style="background:var(--primary-color); border:none; color:white; padding:0 10px; border-radius:5px; margin-right:5px;">➤</button>
                </div>
            </div>
        </div>

        <!-- Game Board -->
        <div id="screen-game" class="screen">

            <div class="turn-indicator">
                <div id="badge-x" class="player-badge bg-x active">❌ <span id="disp-p1">Player 1</span></div>
                <div id="badge-o" class="player-badge bg-o">⭕ <span id="disp-p2">Player 2</span></div>
            </div>
            <!-- Timer & Controls -->
            <div
                style="background:#0f172a; padding:15px; border-radius:15px; margin-bottom:20px; border:1px solid #334155;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:1.2rem; display:flex; gap:10px;">
                        ⏳ <span id="timer-val"
                            style="font-weight:bold; color:var(--accent-color); font-size:1.5rem; width:40px; text-align:center;">30</span>
                    </span>
                    <div style="display:flex; gap:5px;">
                        <button class="btn" style="padding:5px 10px; font-size:1rem;" onclick="toggleTimer()"
                            title="إيقاف/تشغيل المؤقت">⏯️</button>
                        <button class="btn" style="padding:5px 10px; font-size:1rem;" onclick="resetTimerManual()"
                            title="إعادة المؤقت">🔄</button>
                    </div>
                </div>
                <div class="timer-bar">
                    <div id="timer-fill" class="timer-fill"></div>
                </div>
            </div>

            <div class="card" style="padding: 10px;">
                <div id="game-grid" class="game-grid">
                    <!-- Grid will be generated by JS -->
                </div>
            </div>

            <div style="margin-top: 20px; display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-secondary" onclick="undoMove()">↩ تراجع</button>
                <button class="btn btn-create" onclick="resetGame()">🔄 لعبة جديدة</button>
                <button class="btn btn-secondary" onclick="showScreen('screen-menu')">خروج</button>
            </div>
        </div>

    </div>

    <!-- Input Modal -->
    <div id="input-modal">
        <div class="modal-content">
            <h3>من هو اللاعب؟</h3>
            <p id="modal-criteria" style="color:var(--accent-color); font-size:0.9rem;">...</p>
            <input type="text" id="player-input" class="game-input" placeholder="اكتب اسم اللاعب..." autocomplete="off">
            <button class="btn btn-blue" onclick="submitMove()">✅ تأكيد</button>
            <button class="btn btn-secondary" onclick="closeModal()">إلغاء</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, onDisconnect }
            from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        // Reuse config from gasos.html
        const firebaseConfig = {
            apiKey: "AIzaSyCp9_P3K__Sr76iKgaVG1iD4NluUqPtni4",
            authDomain: "heka-codenames.firebaseapp.com",
            databaseURL: "https://heka-codenames-default-rtdb.firebaseio.com",
            projectId: "heka-codenames",
            storageBucket: "heka-codenames.firebasestorage.app",
            messagingSenderId: "901713932504",
            appId: "1:901713932504:web:b6710ddf537cd3c7c4e7ad",
            measurementId: "G-TSSGCQ1CED"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Data (Challenges) ---
        /* Same Challenge Data as before (shortened for brevity in this tool call, but strictly keeping the list I just added) */
        // NOTE: I am assuming the challenge list is already in memory or I need to re-declare it if I replaced the script. 
        // Since I'm replacing the whole script, I MUST Include the data again or expose it window. 
        // Better to re-declare it inside the module or attach to window if it was outside.
        // Wait, the previous tool was "replace_file_content" which replaces a chunk. 
        // I will re-include the challenges object here to be safe and ensure it's available.

        const challenges = {
            rows: [
                { id: 'brazil', text: 'برازيلي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/brazil.png' },
                { id: 'argentina', text: 'أرجنتيني', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/argentina.png' },
                { id: 'france', text: 'فرنسي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/france.png' },
                { id: 'england', text: 'إنجليزي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/england.png' },
                { id: 'spain', text: 'إسباني', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/spain.png' },
                { id: 'germany', text: 'ألماني', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/germany.png' },
                { id: 'italy', text: 'إيطالي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/italy.png' },
                { id: 'portugal', text: 'برتغالي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/portugal.png' },
                { id: 'netherlands', text: 'هولندي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/netherlands.png' },
                { id: 'belgium', text: 'بلجيكي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/belgium.png' },
                { id: 'croatia', text: 'كرواتي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/croatia.png' },
                { id: 'uruguay', text: 'أوروجواي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/uruguay.png' },
                { id: 'morocco', text: 'مغربي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/morocco.png' },
                { id: 'egypt', text: 'مصري', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/egypt.png' },
                { id: 'senegal', text: 'سنغالي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/senegal.png' },
                { id: 'nigeria', text: 'نيجيري', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/nigeria.png' },
                { id: 'ivory_coast', text: 'إيفواري', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ivory_coast.png' },
                { id: 'algeria', text: 'جزائري', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/algeria.png' },
                { id: 'japan', text: 'ياباني', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/japan.png' },
                { id: 'south_korea', text: 'كوري جنوبي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/south_korea.png' },
                { id: 'usa', text: 'أمريكي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/usa.png' },
                { id: 'mexico', text: 'مكسيكي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/mexico.png' },
                { id: 'colombia', text: 'كولومبي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/colombia.png' },
                { id: 'chile', text: 'تشيلي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/chile.png' },
                { id: 'laliga', text: 'الدوري الإسباني', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/laliga.png' },
                { id: 'pl', text: 'الدوري الإنجليزي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/pl.png' },
                { id: 'seriea', text: 'الدوري الإيطالي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/seriea.png' },
                { id: 'bundesliga', text: 'الدوري الألماني', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/bundesliga.png' },
                { id: 'ligue1', text: 'الدوري الفرنسي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ligue1.png' },
                { id: 'saudi_league', text: 'الدوري السعودي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/saudi_league.png' },
                { id: 'mls', text: 'الدوري الأمريكي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/mls.png' },
                { id: 'brasileirao', text: 'الدوري البرازيلي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/brasileirao.png' },
                { id: 'eredivisie', text: 'الدوري الهولندي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/eredivisie.png' },
                { id: 'primeira_liga', text: 'الدوري البرتغالي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/primeira_liga.png' },
                { id: 'super_lig', text: 'الدوري التركي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/super_lig.png' }
            ],
            cols: [
                { id: 'real_madrid', text: 'ريال مدريد', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/real_madrid.png' },
                { id: 'barcelona', text: 'برشلونة', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/barcelona.png' },
                { id: 'atletico', text: 'أتلتيكو مدريد', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/atletico.png' },
                { id: 'man_utd', text: 'اليونايتد', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/man_utd.png' },
                { id: 'man_city', text: 'السيتي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/man_city.png' },
                { id: 'liverpool', text: 'ليفربول', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/liverpool.png' },
                { id: 'arsenal', text: 'أرسنال', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/arsenal.png' },
                { id: 'chelsea', text: 'تشيلسي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/chelsea.png' },
                { id: 'tottenham', text: 'توتنهام', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/tottenham.png' },
                { id: 'juventus', text: 'يوفنتوس', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/juventus.png' },
                { id: 'ac_milan', text: 'ميلان', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ac_milan.png' },
                { id: 'inter', text: 'إنتر', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/inter.png' },
                { id: 'napoli', text: 'نابولي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/napoli.png' },
                { id: 'roma', text: 'روما', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/roma.png' },
                { id: 'bayern', text: 'بايرن ميونخ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/bayern.png' },
                { id: 'dortmund', text: 'دورتموند', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/dortmund.png' },
                { id: 'psg', text: 'باريس (PSG)', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/psg.png' },
                { id: 'ajax', text: 'أياكس', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ajax.png' },
                { id: 'benfica', text: 'بنفيكا', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/benfica.png' },
                { id: 'porto', text: 'بورتو', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/porto.png' },
                { id: 'al_nassr', text: 'النصر', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/al_nassr.png' },
                { id: 'al_hilal', text: 'الهلال', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/al_hilal.png' },
                { id: 'world_cup_winner', text: 'بطل كأس العالم', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/world_cup_winner.png' },
                { id: 'ucl_winner', text: 'بطل دوري الأبطال', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ucl_winner.png' },
                { id: 'europa_league', text: 'بطل يوروبا ليج', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/europa_league.png' },
                { id: 'copa_america', text: 'بطل كوبا أمريكا', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/copa_america.png' },
                { id: 'euro_winner', text: 'بطل اليورو', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/euro_winner.png' },
                { id: 'ballon_dor', text: 'الكرة الذهبية', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ballon_dor.png' },
                { id: 'golden_boot', text: 'الحذاء الذهبي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/golden_boot.png' },
                { id: 'golden_boy', text: 'الفتى الذهبي', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/golden_boy.png' },
                { id: 'puskas', text: 'جائزة بوشكاش 🥅' },
                { id: 'league_winner', text: 'بطل الدوري (أي دوري كبير) 🥇' },
                { id: 'club_world_cup', text: 'بطل كأس العالم للأندية', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/club_world_cup.png' },
                { id: 'goal_scorer_300', text: '+300 هدف في مسيرته ⚽' },
                { id: 'goal_scorer_500', text: '+500 هدف في مسيرته ⚽🔥' },
                { id: 'one_club_man', text: 'لعب لنادي واحد فقط 🛡️' },
                { id: 'played_for_rivals', text: 'لعب للغريمين (مثلاً الريال والبرسا) 😈' },
                { id: 'manager_now', text: 'أصبح مدرباً حالياً 👔' },
                { id: 'retired', text: 'معتزل 🚪' },
                { id: 'active', text: 'ما زال يلعب 🏃' },
                { id: 'left_foot', text: 'أشول (القدم اليسرى) 🦶' },
                { id: 'both_feet', text: 'يلعب بالقدمين 🦶🦶' },
                { id: 'tall_190', text: 'طوله +190 سم 🦒' },
                { id: 'short_170', text: 'طوله -170 سم 🐜' },
                { id: 'gk', text: 'حارس مرمى 🧤' },
                { id: 'defender', text: 'مدافع (CB/LB/RB) 🛡️' },
                { id: 'midfielder', text: 'لاعب وسط (CM/CAM/CDM) 🎯' },
                { id: 'forward', text: 'مهاجم (ST/RW/LW) ⚡' },
                { id: 'jersey_10', text: 'رقم 10 👕' },
                { id: 'jersey_7', text: 'رقم 7 👕' },
                { id: 'jersey_9', text: 'رقم 9 👕' },
                { id: 'jersey_1', text: 'رقم 1 👕' },
                { id: 'captain', text: 'كابتن منتخب بلاده ©' },
                { id: 'bald', text: 'أصلع 👨‍🦲' },
                { id: 'long_hair', text: 'شعره طويل 🦁' },
                { id: 'siblings', text: 'لديه أخ لاعب كرة 👬' },
                { id: 'father_player', text: 'والده كان لاعب كرة 👨‍👦' }
            ]
        };

        // --- Globals ---
        window.myName = localStorage.getItem('heka_global_player_name') || "";
        window.myRoomId = null;
        window.myPlayerId = null; // 'X' or 'O' in online mode context? No, usually host/joiner. Let's use 'X' or 'O' as role later.
        window.isOnline = false;

        // Game State (Shared)
        let localState = {
            board: Array(9).fill(null),
            cells: Array(9).fill(null),
            turn: 'X',
            timer: 45,
            history: [],
            activeRows: [],
            activeCols: [],
            p1Name: 'Player 1',
            p2Name: 'Player 2',
            myRole: null // 'X' or 'O'
        };

        let timerInterval = null;

        // --- Basic UI Ops ---
        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            setTimeout(() => document.getElementById(id).classList.add('active'), 100);
        };

        // --- Offline Only Wrappers ---
        window.startOfflineSetup = () => {
            window.isOnline = false;
            // Simplify: Skip setup screen, use defaults
            localState.p1Name = localStorage.getItem('heka_username') || "Player 1";
            localState.p2Name = "Player 2";
            localState.myRole = 'BOTH';

            document.getElementById('disp-p1').innerText = localState.p1Name;
            document.getElementById('disp-p2').innerText = localState.p2Name;

            initGameConfig();
            renderGrid();
            resetTimer(30);
            updateTurnUI();

            window.showScreen('screen-game');
        };

        window.startGameOffline = () => {
            localState.p1Name = document.getElementById('p1-name').value || 'Player 1';
            localState.p2Name = document.getElementById('p2-name').value || 'Player 2';
            localState.myRole = 'BOTH'; // Offline controls both

            document.getElementById('disp-p1').innerText = localState.p1Name;
            document.getElementById('disp-p2').innerText = localState.p2Name;

            initGameConfig(); // Pick random rows
            renderGrid();
            resetTimer(45);
            updateTurnUI();

            window.showScreen('screen-game');
        };

        // --- Online Logic ---
        window.createOnlineRoom = () => {
            if (!window.myName) return alert("الرجاء تسجيل اسمك في الصفحة الرئيسية أو الإعدادات");
            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            window.myRoomId = roomId;
            window.myPlayerId = "host";
            window.isOnline = true;
            localState.myRole = 'X'; // Host is X

            // Initial Game State
            const startRows = getRandom(challenges.rows, 3);
            const startCols = getRandom(challenges.cols, 3);

            set(ref(db, `football_rooms/${roomId}`), {
                status: 'waiting',
                p1: { name: window.myName, role: 'X' },
                activeRows: startRows,
                activeCols: startCols,
                board: Array(9).fill(null),
                cells: Array(9).fill(null),
                turn: 'X',
                timer: 45
            });

            enterOnlineLobby(roomId);
        };

        window.joinOnlineRoom = () => {
            const code = document.getElementById('room-code-input').value;
            if (!code) return alert("أدخل كود الغرفة");
            window.myRoomId = code;
            window.myPlayerId = "joiner";
            window.isOnline = true;

            get(ref(db, `football_rooms/${code}`)).then(snap => {
                if (snap.exists()) {
                    // Update P2
                    update(ref(db, `football_rooms/${code}`), {
                        status: 'playing',
                        p2: { name: window.myName, role: 'O' }
                    });
                    localState.myRole = 'O'; // Joiner is O
                    enterOnlineLobby(code);
                } else {
                    alert("الغرفة غير موجودة");
                }
            });
        };

        function enterOnlineLobby(roomId) {
            window.showScreen('screen-online-lobby');
            document.getElementById('lobby-code').innerText = roomId;

            // Listen to updates
            onValue(ref(db, `football_rooms/${roomId}`), (snap) => {
                const data = snap.val();
                if (!data) return;

                // Update Lobby UI always
                const p1 = data.p1 ? data.p1.name : '...';
                const p2 = data.p2 ? data.p2.name : '...';
                document.getElementById('lobby-p1').innerText = p1;
                document.getElementById('lobby-p2').innerText = p2;

                if (data.status === 'waiting') {
                    document.getElementById('lobby-status').innerText = data.p2 ? "في انتظار بدء المضيف..." : "في انتظار اللاعب الثاني...";
                    if (window.myPlayerId === 'host' && data.p2 && document.getElementById('screen-online-lobby').classList.contains('active')) {
                        // Auto start or show button? Scrip logic auto-starts on join in joinRoom, let's keep it simple.
                        // Actually joinRoom sets status to 'playing'.
                    }
                }

                if (data.status === 'playing') {
                    // Sync State
                    localState.board = data.board || Array(9).fill(null);
                    localState.cells = data.cells || Array(9).fill(null);
                    localState.turn = data.turn;
                    localState.activeRows = data.activeRows;
                    localState.activeCols = data.activeCols;
                    localState.p1Name = p1;
                    localState.p2Name = p2;

                    // Render
                    document.getElementById('disp-p1').innerText = localState.p1Name;
                    document.getElementById('disp-p2').innerText = localState.p2Name;

                    renderGrid();
                    updateTurnUI();

                    // If I am not active screen yet, go there
                    if (!document.getElementById('screen-game').classList.contains('active')) {
                        window.showScreen('screen-game');
                        resetTimer(45); // Start fresh on game start
                    }

                    // Handle Chat (Subscribe)
                    subscribeToChat(roomId);
                    document.getElementById('chat-widget').classList.remove('hidden');
                }
            });
        }

        // --- Chat System ---
        function subscribeToChat(roomId) {
            // Use Child Added for efficiency or onValue for simplicity (list is small)
            // Let's use onValue and render all for simplicity
            onValue(ref(db, `football_rooms/${roomId}/chat`), (snap) => {
                const msgs = snap.val();
                const container = document.getElementById('chat-messages');
                container.innerHTML = '';

                if (msgs) {
                    Object.values(msgs).forEach(msg => {
                        const div = document.createElement('div');
                        const isMe = msg.sender === window.myName;
                        div.style.padding = '5px 10px';
                        div.style.margin = '5px 0';
                        div.style.borderRadius = '10px';
                        div.style.background = isMe ? '#3b82f6' : '#334155';
                        div.style.alignSelf = isMe ? 'flex-end' : 'flex-start';
                        div.style.width = 'fit-content';
                        div.style.maxWidth = '80%';
                        div.innerText = `${msg.sender}: ${msg.text}`;
                        container.appendChild(div);
                    });
                    container.scrollTop = container.scrollHeight;
                }
            });
        }

        window.toggleChat = () => {
            const box = document.getElementById('chat-box');
            box.style.display = box.style.display === 'none' ? 'flex' : 'none';
        };

        window.sendChatMessage = () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !window.myRoomId) return;

            const msgId = "msg_" + Date.now();
            update(ref(db, `football_rooms/${window.myRoomId}/chat/${msgId}`), {
                sender: window.myName,
                text: text
            });
            input.value = '';
        };

        // --- Core Game Logic (Mixed) ---
        function initGameConfig() {
            localState.activeRows = getRandom(challenges.rows, 3);
            localState.activeCols = getRandom(challenges.cols, 3);
            localState.board = Array(9).fill(null);
            localState.cells = Array(9).fill(null);
            localState.turn = 'X';
            localState.history = [];
        }

        function getRandom(arr, n) {
            const shuffled = [...arr].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, n);
        }

        // RENDER GRID (Updated)
        function renderGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = '';

            // Header Icon
            const tl = document.createElement('div');
            tl.className = 'cell header-cell';
            tl.innerHTML = '⚽';
            grid.appendChild(tl);

            // Cols Headers
            localState.activeCols.forEach(col => {
                const cel = document.createElement('div');
                cel.className = 'cell header-cell';
                cel.style.flexDirection = 'column';
                cel.style.gap = '5px';
                cel.style.padding = '5px';
                if (col.img) {
                    cel.innerHTML = `<img src="${col.img}" style="width:40px; height:40px; object-fit:contain;"> <span style="font-size:0.9rem; font-weight:bold; line-height:1.2;">${col.text}</span>`;
                } else {
                    cel.innerText = col.text;
                    cel.style.fontSize = '0.9rem';
                    cel.style.fontWeight = 'bold';
                }
                grid.appendChild(cel);
            });

            // Rows + Cells
            localState.activeRows.forEach((row, rIdx) => {
                const rh = document.createElement('div');
                rh.className = 'cell header-cell';
                rh.style.flexDirection = 'column';
                rh.style.gap = '5px';
                rh.style.padding = '5px';
                if (row.img) {
                    rh.innerHTML = `<img src="${row.img}" style="width:40px; height:40px; object-fit:contain;"> <span style="font-size:0.9rem; font-weight:bold; line-height:1.2;">${row.text}</span>`;
                } else {
                    rh.innerText = row.text;
                    rh.style.fontSize = '0.9rem';
                    rh.style.fontWeight = 'bold';
                }
                grid.appendChild(rh);

                for (let cIdx = 0; cIdx < 3; cIdx++) {
                    const cellIdx = (rIdx * 3) + cIdx;
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'cell game-cell';

                    if (localState.cells[cellIdx]) {
                        const data = localState.cells[cellIdx];
                        cellDiv.style.cursor = 'default';
                        cellDiv.classList.add('taken');
                        cellDiv.classList.add(data.p === 'X' ? 'taken-x' : 'taken-o');

                        // Show name if exists, else just mark
                        let content = `<div class="player-mark">${data.p}</div>`;
                        if (data.name) content += `<div class="player-name-label">${data.name}</div>`;
                        cellDiv.innerHTML = content;
                    } else {
                        // Clickability
                        cellDiv.onclick = () => handleCellClick(cellIdx, row, localState.activeCols[cIdx]);
                    }
                    grid.appendChild(cellDiv);
                }
            });
        }

        let selectedCellIdx = null;

        function handleCellClick(idx, row, col) {
            // Permission Check (Online)
            if (window.isOnline) {
                if (localState.turn !== localState.myRole) return; // Not my turn
            }

            if (localState.cells[idx]) return;

            selectedCellIdx = idx;

            // OFFLINE: Immediate Move
            if (!window.isOnline) {
                submitMove(null, true); // No name needed
                return;
            }

            // ONLINE: Show Modal (still need validation? User said simple offline, implied online simplified too? 
            // "In offline... fill with X or O... say voice". 
            // "Undo remove mark in offline AND online".
            // Let's keep modal for Online for clarity/verification, as voice isn't guaranteed online.
            // But if user insists on simplified, I'll stick to Online Modal for now as specific request was "First in offline...".

            document.getElementById('modal-criteria').innerText = `مطلوب لاعب: ${row.text} + ${col.text}`;
            document.getElementById('player-input').value = '';
            document.getElementById('input-modal').style.display = 'flex';
            document.getElementById('player-input').focus();
        }

        window.closeModal = () => {
            document.getElementById('input-modal').style.display = 'none';
        };

        window.submitMove = (overrideName = null, isOfflineSimple = false) => {
            let name = overrideName;

            if (!isOfflineSimple && !name) {
                name = document.getElementById('player-input').value.trim();
                // If online and empty, maybe allow? Let's require something or allow empty if they just want to mark.
                // "Say it with voice" -> maybe they chat it?
                // Let's default to "---" if empty to allow mark.
                if (!name) name = "---";
            }

            // Capture state for Undo (Online needs this too now)
            const snapshot = {
                board: [...localState.board],
                cells: [...localState.cells],
                turn: localState.turn,
                timer: localState.timer // Snap timer?
            };

            // Should we push to history? 
            // In Online, we only push history if WE make the move, to allow Undo.
            // Actually, if we want to Undo online, we need to revert Firebase.
            // So we need the PREVIOUS state of the board.
            localState.history.push(snapshot);


            // Update Local
            localState.cells[selectedCellIdx] = { p: localState.turn, name: name };
            localState.board[selectedCellIdx] = localState.turn;

            // Push to Firebase if online
            if (window.isOnline) {
                const updates = {};
                updates[`football_rooms/${window.myRoomId}/cells/${selectedCellIdx}`] = { p: localState.turn, name: name };
                updates[`football_rooms/${window.myRoomId}/board/${selectedCellIdx}`] = localState.turn;
                updates[`football_rooms/${window.myRoomId}/turn`] = (localState.turn === 'X' ? 'O' : 'X');
                update(ref(db), updates);

                // Note: Timer sync is loose. We rely on 'turn' change to reset timer on other side.
                // But for us, we switch immediately logically.
                // Actually, render waits for Firebase update? No, we update local too for responsiveness.
                // But 'onValue' will come back and confirm.
            } else {
                // Offline Logic
                localState.turn = localState.turn === 'X' ? 'O' : 'X';
                resetTimer(30);
                renderGrid();
                updateTurnUI();
            }

            closeModal();
            checkWin();
        };

        window.undoMove = () => {
            if (localState.history.length === 0) return alert("لا يوجد حركات للتراجع عنها");

            // For Online: Can only undo if it is currently NOT my turn (meaning I just played)
            // AND the previous move was mine.
            // Or simpler: Just revert the last history state.

            const last = localState.history.pop();

            if (window.isOnline) {
                // Check if the move we are undoing matches the current state (sanity check)
                // If opponent played after us, undoing might be messy.
                // "Undo removes mark". 
                // If localState.turn != myRole, it means I just played (or opponent is thinking).
                // If I play, turn becomes Opponent.
                // So if turn is Opponent, I can Undo?
                // What if Opponent played? Then turn is Mine. 
                // If turn is Mine, I can Undo Opponent's move? No.
                // Assuming Cooperative play or "Undo" = "Take back my last mistake".
                // Let's implement global Undo: Revert the game state to `last`.

                const updates = {};
                updates[`football_rooms/${window.myRoomId}/board`] = last.board;
                updates[`football_rooms/${window.myRoomId}/cells`] = last.cells;
                updates[`football_rooms/${window.myRoomId}/turn`] = last.turn;
                update(ref(db), updates);

                // Local state will update via onValue
            } else {
                localState.board = last.board;
                localState.cells = last.cells;
                localState.turn = last.turn;
                resetTimer(30); // Reset timer on undo
                renderGrid();
                updateTurnUI();
            }
        };

        // --- Helpers ---
        function updateTurnUI() {
            if (localState.turn === 'X') {
                document.getElementById('badge-x').classList.add('active');
                document.getElementById('badge-o').classList.remove('active');
            } else {
                document.getElementById('badge-x').classList.remove('active');
                document.getElementById('badge-o').classList.add('active');
            }
        }

        let isPaused = false;

        window.toggleTimer = () => {
            isPaused = !isPaused;
        };

        window.resetTimerManual = () => {
            resetTimer(30);
            isPaused = true; // Pause on manual reset? Or run? Let's run.
            isPaused = false;
        };

        function resetTimer(secs) {
            if (timerInterval) clearInterval(timerInterval);
            localState.timer = secs;
            updateTimerDisp();
            isPaused = false;

            timerInterval = setInterval(() => {
                if (isPaused) return;

                localState.timer--;
                updateTimerDisp();

                if (localState.timer <= 0) {
                    // Timeout -> Switch Turn
                    localState.timer = 0;
                    // Switch
                    const nextTurn = localState.turn === 'X' ? 'O' : 'X';

                    if (window.isOnline) {
                        // Only the player whose turn it CANCELLED (or host?) should update? 
                        // To avoid double writes.
                        // Let's say: If it is MY turn and I time out -> I update.
                        if (localState.turn === localState.myRole) {
                            const updates = {};
                            updates[`football_rooms/${window.myRoomId}/turn`] = nextTurn;
                            update(ref(db), updates);
                            // Note: We don't push history on timeout switch?
                        }
                    } else {
                        localState.turn = nextTurn;
                        renderGrid(); // Redraw check interactivity
                        updateTurnUI();
                        resetTimer(30);
                    }
                }
            }, 1000);
        }

        function updateTimerDisp() {
            const el = document.getElementById('timer-val');
            const fill = document.getElementById('timer-fill');
            if (el) el.innerText = localState.timer;
            if (fill) fill.style.width = `${(localState.timer / 30) * 100}%`; // Based on 30s
        }

        window.resetGame = () => {
            if (window.isOnline) {
                if (window.myPlayerId !== 'host') return alert("فقط المضيف (اللاعب 1) يمكنه تغيير التحديات وبدء لعبة جديدة");
                if (!confirm("هل تريد تغيير التحديات وبدء جولة جديدة؟")) return;

                const newRows = getRandom(challenges.rows, 3);
                const newCols = getRandom(challenges.cols, 3);

                const updates = {};
                updates[`football_rooms/${window.myRoomId}/board`] = Array(9).fill(null);
                updates[`football_rooms/${window.myRoomId}/cells`] = Array(9).fill(null);
                updates[`football_rooms/${window.myRoomId}/turn`] = 'X';
                updates[`football_rooms/${window.myRoomId}/activeRows`] = newRows;
                updates[`football_rooms/${window.myRoomId}/activeCols`] = newCols;

                update(ref(db), updates);
            } else {
                if (confirm("إعادة؟")) window.startGameOffline();
            }
        };

        // --- Helpers ---




        function checkWin() {
            const wins = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
            let winner = null;
            for (let w of wins) {
                const b = localState.board;
                if (b[w[0]] && b[w[0]] === b[w[1]] && b[w[0]] === b[w[2]]) {
                    winner = b[w[0]];
                    break;
                }
            }
            if (winner) {
                setTimeout(() => alert(`الفائز ${winner}!`), 100);
            }
        }

        // Expose to window for UI onclicks
    </script>

</body>

</html>
