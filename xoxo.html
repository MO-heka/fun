<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âš½ XO Football</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Tajawal:wght@500;700;900&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #0f172a;
            --card-color: #1e293b;
            --primary-color: #3b82f6;
            --accent-color: #f59e0b;
            /* Gold for trophies */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --player-x: #3b82f6;
            --player-o: #ef4444;
            --grid-border: #334155;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            /* Prevent accidental selection */
        }

        body {
            font-family: 'Cairo', 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        /* Screens */
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .screen.active {
            display: block;
            opacity: 1;
        }

        /* Card Style */
        .card {
            background-color: var(--card-color);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin: 10px 0;
            font-weight: 900;
        }

        .btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: transform 0.1s;
            color: white;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-blue {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .btn-green {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-gold {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #000;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #334155;
            color: var(--text-muted);
        }

        /* Game Grid */
        .game-board-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 1fr;
            grid-template-rows: 80px 1fr 1fr 1fr;
            gap: 5px;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1/1;
            /* Square board */
        }

        .cell {
            background: var(--card-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--grid-border);
            padding: 5px;
        }

        /* Headers */
        .header-cell {
            background: #0f172a;
            color: var(--accent-color);
            font-size: 0.75rem;
            border: none;
        }

        .header-cell img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-bottom: 2px;
        }

        /* Playable Cells */
        .game-cell {
            background: #1e293b;
            cursor: pointer;
            transition: background 0.2s;
        }

        .game-cell:active {
            background: #334155;
        }

        .game-cell.taken {
            cursor: default;
        }

        .game-cell.taken-x {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--player-x);
        }

        .game-cell.taken-o {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--player-o);
        }

        .player-mark {
            font-size: 2rem;
            opacity: 0.2;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        .player-name-label {
            z-index: 1;
            font-size: 0.8rem;
            word-break: break-word;
            line-height: 1.2;
        }

        /* Timer Bar */
        .timer-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }

        .timer-fill {
            height: 100%;
            background: var(--primary-color);
            width: 100%;
            transition: width 1s linear;
        }

        .timer-text {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 5px;
        }

        .timer-warning {
            color: #ef4444;
        }

        /* Turn Indicator */
        .turn-indicator {
            display: flex;
            justify-content: space-between;
            background: var(--card-color);
            padding: 10px 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--grid-border);
        }

        .player-badge {
            padding: 5px 15px;
            border-radius: 10px;
            opacity: 0.5;
            font-weight: bold;
            transition: 0.3s;
        }

        .player-badge.active {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        .bg-x {
            background: var(--player-x);
        }

        .bg-o {
            background: var(--player-o);
        }

        /* Input Modal */
        #input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-color);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--primary-color);
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        input.game-input {
            width: 100%;
            padding: 15px;
            background: #0f172a;
            border: 2px solid var(--grid-border);
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            text-align: center;
            margin: 15px 0;
            outline: none;
        }

        input.game-input:focus {
            border-color: var(--primary-color);
        }

        /* Utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- Main Menu -->
        <!-- Update Menu Button -->
        <div id="screen-menu" class="screen active card">
            <h1 style="font-size: 4rem;">âš½âŒâ­•</h1>
            <h1>ØªØ­Ø¯ÙŠ ÙƒÙˆØ±Ø©</h1>
            <p style="color:var(--text-muted)">Ù„Ø¹Ø¨Ø© XO Ø¨Ø³ Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„ÙƒØ±ÙˆÙŠØ©</p>

            <button class="btn btn-blue" onclick="startOfflineSetup()">ğŸ“± Ù„Ø¹Ø¨ Ù…Ø­Ù„ÙŠ (Offline)</button>
            <button class="btn btn-green" onclick="showScreen('screen-online-setup')">ğŸŒ Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Online)</button>
            <button class="btn btn-secondary" onclick="alert('Ù‚ÙˆÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ÙŠ ØªØ´ØªØ±Ùƒ ÙÙŠÙ‡ ØµÙØ§Øª Ø§Ù„Ø¹Ø§Ù…ÙˆØ¯ Ùˆ Ø§Ù„ØµÙ')">â“ ÙƒÙŠÙÙŠØ©
                Ø§Ù„Ù„Ø¹Ø¨</button>
        </div>

        <!-- Offline Setup -->
        <div id="screen-offline-setup" class="screen card">
            <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨</h2>
            <div style="margin: 20px 0;">
                <label>Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ (X)</label>
                <input type="text" id="p1-name" class="game-input" value="Ø§Ù„Ù„Ø§Ø¹Ø¨ 1" placeholder="Ø§Ø³Ù…Ùƒ">

                <label>Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ (O)</label>
                <input type="text" id="p2-name" class="game-input" value="Ø§Ù„Ù„Ø§Ø¹Ø¨ 2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®ØµÙ…">
            </div>
            <button class="btn btn-blue" onclick="startGameOffline()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ğŸš€</button>
            <button class="btn btn-secondary" onclick="showScreen('screen-menu')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <!-- Online Setup -->
        <div id="screen-online-setup" class="screen card">
            <h2>ğŸŒ Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h2>
            <div style="margin: 20px 0;">
                <button class="btn btn-create" onclick="createOnlineRoom()">âœ¨ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
                <div style="margin:15px; border-top:1px solid #334155"></div>
                <input type="number" id="room-code-input" class="game-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (4 Ø£Ø±Ù‚Ø§Ù…)">
                <button class="btn btn-blue" onclick="joinOnlineRoom()">Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©</button>
            </div>
            <button class="btn btn-secondary" onclick="showScreen('screen-menu')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <!-- Online Lobby -->
        <div id="screen-online-lobby" class="screen card">
            <h2 style="color:var(--accent-color)">Ø±Ø¯Ù‡Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h2>
            <p>Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ ØµØ¯ÙŠÙ‚Ùƒ:</p>
            <h1 id="lobby-code" style="letter-spacing: 5px; font-size: 3rem;">----</h1>

            <div style="text-align:right; background:#0f172a; padding:15px; border-radius:10px; margin:10px 0;">
                <p>ğŸ‘¤ Ø§Ù„Ù„Ø§Ø¹Ø¨ 1: <span id="lobby-p1" style="color:#3b82f6; font-weight:bold;">...</span></p>
                <p>ğŸ‘¤ Ø§Ù„Ù„Ø§Ø¹Ø¨ 2: <span id="lobby-p2" style="color:#ef4444; font-weight:bold;">...</span></p>
            </div>

            <p id="lobby-status">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ...</p>
        </div>

        <!-- Chat Widget Removed -->

        <!-- Game Board -->
        <div id="screen-game" class="screen">

            <div class="turn-indicator">
                <div id="badge-x" class="player-badge bg-x active">âŒ <span id="disp-p1">Player 1</span></div>
                <div id="badge-o" class="player-badge bg-o">â­• <span id="disp-p2">Player 2</span></div>
            </div>
            <!-- Timer Removed. Host Controls -->
            <div id="host-controls" style="display:none; margin-bottom:15px; text-align:center;">
                <button class="btn btn-secondary" onclick="forceSkipTurn()">â­ï¸ ØªØ®Ø·ÙŠ Ø§Ù„Ø¯ÙˆØ± (Ù…Ø´Ø±Ù)</button>
            </div>

            <div class="card" style="padding: 10px;">
                <div id="game-grid" class="game-grid">
                    <!-- Grid will be generated by JS -->
                </div>
            </div>

            <div style="margin-top: 20px; display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-secondary" onclick="undoMove()">â†© ØªØ±Ø§Ø¬Ø¹</button>
                <button class="btn btn-create" onclick="resetGame()">ğŸ”„ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                <button class="btn btn-secondary" onclick="showScreen('screen-menu')">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

    </div>

    <!-- Input Modal -->
    <div id="input-modal">
        <div class="modal-content">
            <h3>Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨ØŸ</h3>
            <p id="modal-criteria" style="color:var(--accent-color); font-size:0.9rem;">...</p>
            <input type="text" id="player-input" class="game-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨..." autocomplete="off">
            <button class="btn btn-blue" onclick="submitMove()">âœ… ØªØ£ÙƒÙŠØ¯</button>
            <button class="btn btn-secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, onDisconnect }
            from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        // Reuse config from gasos.html
        const firebaseConfig = {
            apiKey: "AIzaSyCp9_P3K__Sr76iKgaVG1iD4NluUqPtni4",
            authDomain: "heka-codenames.firebaseapp.com",
            databaseURL: "https://heka-codenames-default-rtdb.firebaseio.com",
            projectId: "heka-codenames",
            storageBucket: "heka-codenames.firebasestorage.app",
            messagingSenderId: "901713932504",
            appId: "1:901713932504:web:b6710ddf537cd3c7c4e7ad",
            measurementId: "G-TSSGCQ1CED"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Data (Challenges) ---
        /* Same Challenge Data as before (shortened for brevity in this tool call, but strictly keeping the list I just added) */
        // NOTE: I am assuming the challenge list is already in memory or I need to re-declare it if I replaced the script. 
        // Since I'm replacing the whole script, I MUST Include the data again or expose it window. 
        // Better to re-declare it inside the module or attach to window if it was outside.
        // Wait, the previous tool was "replace_file_content" which replaces a chunk. 
        // I will re-include the challenges object here to be safe and ensure it's available.

        const challenges = {
            rows: [
                { id: 'brazil', text: 'Ø¨Ø±Ø§Ø²ÙŠÙ„ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/brazil.png' },
                { id: 'argentina', text: 'Ø£Ø±Ø¬Ù†ØªÙŠÙ†ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/argentina.png' },
                { id: 'france', text: 'ÙØ±Ù†Ø³ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/france.png' },
                { id: 'england', text: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/england.png' },
                { id: 'spain', text: 'Ø¥Ø³Ø¨Ø§Ù†ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/spain.png' },
                { id: 'germany', text: 'Ø£Ù„Ù…Ø§Ù†ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/germany.png' },
                { id: 'italy', text: 'Ø¥ÙŠØ·Ø§Ù„ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/italy.png' },
                { id: 'portugal', text: 'Ø¨Ø±ØªØºØ§Ù„ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/portugal.png' },
                { id: 'netherlands', text: 'Ù‡ÙˆÙ„Ù†Ø¯ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/netherlands.png' },
                { id: 'belgium', text: 'Ø¨Ù„Ø¬ÙŠÙƒÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/belgium.png' },
                { id: 'croatia', text: 'ÙƒØ±ÙˆØ§ØªÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/croatia.png' },
                { id: 'uruguay', text: 'Ø£ÙˆØ±ÙˆØ¬ÙˆØ§ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/uruguay.png' },
                { id: 'morocco', text: 'Ù…ØºØ±Ø¨ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/morocco.png' },
                { id: 'egypt', text: 'Ù…ØµØ±ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/egypt.png' },
                { id: 'senegal', text: 'Ø³Ù†ØºØ§Ù„ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/senegal.png' },
                { id: 'nigeria', text: 'Ø§ÙØ±ÙŠÙ‚ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/africa.png' },
                { id: 'ivory_coast', text: 'Ø¥ÙŠÙÙˆØ§Ø±ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ivory_coast.png' },
                { id: 'algeria', text: 'Ø¬Ø²Ø§Ø¦Ø±ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/algeria.png' },
                { id: 'japan', text: 'ÙŠØ§Ø¨Ø§Ù†ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/japan.png' },
                { id: 'south_korea', text: 'ÙƒÙˆØ±ÙŠ Ø¬Ù†ÙˆØ¨ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/south_korea.png' },
                { id: 'usa', text: 'Ø£Ù…Ø±ÙŠÙƒÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/usa.png' },
                { id: 'mexico', text: 'Ù…ÙƒØ³ÙŠÙƒÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/mexico.png' },
                { id: 'colombia', text: 'ÙƒÙˆÙ„ÙˆÙ…Ø¨ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/colombia.png' },
                { id: 'chile', text: 'ØªØ´ÙŠÙ„ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/chile.png' },
                { id: 'laliga', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/laliga.png' },
                { id: 'pl', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/pl.png' },
                { id: 'seriea', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/seriea.png' },
                { id: 'bundesliga', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/bundesliga.png' },
                { id: 'ligue1', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ligue1.png' },
                { id: 'saudi_league', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/saudi_league.png' },
                { id: 'mls', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/mls.png' },
                { id: 'brasileirao', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¨Ø±Ø§Ø²ÙŠÙ„ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/brasileirao.png' },
                { id: 'eredivisie', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ù‡ÙˆÙ„Ù†Ø¯ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/eredivisie.png' },
                { id: 'primeira_liga', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¨Ø±ØªØºØ§Ù„ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/primeira_liga.png' },
                { id: 'super_lig', text: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„ØªØ±ÙƒÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/super_lig.png' }
            ],
            cols: [
                { id: 'real_madrid', text: 'Ø±ÙŠØ§Ù„ Ù…Ø¯Ø±ÙŠØ¯', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/real_madrid.png' },
                { id: 'barcelona', text: 'Ø¨Ø±Ø´Ù„ÙˆÙ†Ø©', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/barcelona.png' },
                { id: 'atletico', text: 'Ø£ØªÙ„ØªÙŠÙƒÙˆ Ù…Ø¯Ø±ÙŠØ¯', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/atletico.png' },
                { id: 'man_utd', text: 'Ø§Ù„ÙŠÙˆÙ†Ø§ÙŠØªØ¯', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/man_utd.png' },
                { id: 'man_city', text: 'Ø§Ù„Ø³ÙŠØªÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/man_city.png' },
                { id: 'liverpool', text: 'Ù„ÙŠÙØ±Ø¨ÙˆÙ„', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/liverpool.png' },
                { id: 'arsenal', text: 'Ø£Ø±Ø³Ù†Ø§Ù„', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/arsenal.png' },
                { id: 'chelsea', text: 'ØªØ´ÙŠÙ„Ø³ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/chelsea.png' },
                { id: 'tottenham', text: 'ØªÙˆØªÙ†Ù‡Ø§Ù…', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/tottenham.png' },
                { id: 'juventus', text: 'ÙŠÙˆÙÙ†ØªÙˆØ³', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/juventus.png' },
                { id: 'ac_milan', text: 'Ù…ÙŠÙ„Ø§Ù†', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ac_milan.png' },
                { id: 'inter', text: 'Ø¥Ù†ØªØ±', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/inter.png' },
                { id: 'napoli', text: 'Ù†Ø§Ø¨ÙˆÙ„ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/napoli.png' },
                { id: 'roma', text: 'Ø±ÙˆÙ…Ø§', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/roma.png' },
                { id: 'bayern', text: 'Ø¨Ø§ÙŠØ±Ù† Ù…ÙŠÙˆÙ†Ø®', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/bayern.png' },
                { id: 'dortmund', text: 'Ø¯ÙˆØ±ØªÙ…ÙˆÙ†Ø¯', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/dortmund.png' },
                { id: 'psg', text: 'Ø¨Ø§Ø±ÙŠØ³ (PSG)', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/psg.png' },
                { id: 'ajax', text: 'Ø£ÙŠØ§ÙƒØ³', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ajax.png' },
                { id: 'benfica', text: 'Ø¨Ù†ÙÙŠÙƒØ§', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/benfica.png' },
                { id: 'porto', text: 'Ø¨ÙˆØ±ØªÙˆ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/porto.png' },
                { id: 'al_nassr', text: 'Ø§Ù„Ù†ØµØ±', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/al_nassr.png' },
                { id: 'al_hilal', text: 'Ø§Ù„Ù‡Ù„Ø§Ù„', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/al_hilal.png' },
                { id: 'world_cup_winner', text: 'Ø¨Ø·Ù„ ÙƒØ£Ø³ Ø§Ù„Ø¹Ø§Ù„Ù…', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/world_cup_winner.png' },
                { id: 'ucl_winner', text: 'Ø¨Ø·Ù„ Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ucl_winner.png' },
                { id: 'europa_league', text: 'Ø¨Ø·Ù„ ÙŠÙˆØ±ÙˆØ¨Ø§ Ù„ÙŠØ¬', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/europa_league.png' },
                { id: 'copa_america', text: 'Ø¨Ø·Ù„ ÙƒÙˆØ¨Ø§ Ø£Ù…Ø±ÙŠÙƒØ§', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/copa_america.png' },
                { id: 'euro_winner', text: 'Ø¨Ø·Ù„ Ø§Ù„ÙŠÙˆØ±Ùˆ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/euro_winner.png' },
                { id: 'ballon_dor', text: 'Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/ballon_dor.png' },
                { id: 'golden_boot', text: 'Ø§Ù„Ø­Ø°Ø§Ø¡ Ø§Ù„Ø°Ù‡Ø¨ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/golden_boot.png' },
                { id: 'golden_boy', text: 'Ø§Ù„ÙØªÙ‰ Ø§Ù„Ø°Ù‡Ø¨ÙŠ', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/golden_boy.png' },
                { id: 'puskas', text: 'Ø¬Ø§Ø¦Ø²Ø© Ø¨ÙˆØ´ÙƒØ§Ø´ ğŸ¥…' },
                { id: 'league_winner', text: 'Ø¨Ø·Ù„ Ø§Ù„Ø¯ÙˆØ±ÙŠ (Ø£ÙŠ Ø¯ÙˆØ±ÙŠ ÙƒØ¨ÙŠØ±) ğŸ¥‡' },
                { id: 'club_world_cup', text: 'Ø¨Ø·Ù„ ÙƒØ£Ø³ Ø§Ù„Ø¹Ø§Ù„Ù… Ù„Ù„Ø£Ù†Ø¯ÙŠØ©', img: 'https://cdn.jsdelivr.net/gh/MO-heka/apk@main/club_world_cup.png' },
                { id: 'goal_scorer_300', text: '+300 Ù‡Ø¯Ù ÙÙŠ Ù…Ø³ÙŠØ±ØªÙ‡ âš½' },
                { id: 'goal_scorer_500', text: '+500 Ù‡Ø¯Ù ÙÙŠ Ù…Ø³ÙŠØ±ØªÙ‡ âš½ğŸ”¥' },
                { id: 'one_club_man', text: 'Ù„Ø¹Ø¨ Ù„Ù†Ø§Ø¯ÙŠ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· ğŸ›¡ï¸' },
                { id: 'played_for_rivals', text: 'Ù„Ø¹Ø¨ Ù„Ù„ØºØ±ÙŠÙ…ÙŠÙ† (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„Ø±ÙŠØ§Ù„ ÙˆØ§Ù„Ø¨Ø±Ø³Ø§) ğŸ˜ˆ' },
                { id: 'manager_now', text: 'Ø£ØµØ¨Ø­ Ù…Ø¯Ø±Ø¨Ø§Ù‹ Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸ‘”' },
                { id: 'retired', text: 'Ù…Ø¹ØªØ²Ù„ ğŸšª' },
                { id: 'active', text: 'Ù…Ø§ Ø²Ø§Ù„ ÙŠÙ„Ø¹Ø¨ ğŸƒ' },
                { id: 'left_foot', text: 'Ø£Ø´ÙˆÙ„ (Ø§Ù„Ù‚Ø¯Ù… Ø§Ù„ÙŠØ³Ø±Ù‰) ğŸ¦¶' },
                { id: 'both_feet', text: 'ÙŠÙ„Ø¹Ø¨ Ø¨Ø§Ù„Ù‚Ø¯Ù…ÙŠÙ† ğŸ¦¶ğŸ¦¶' },
                { id: 'tall_190', text: 'Ø·ÙˆÙ„Ù‡ +190 Ø³Ù… ğŸ¦’' },
                { id: 'short_170', text: 'Ø·ÙˆÙ„Ù‡ -170 Ø³Ù… ğŸœ' },
                { id: 'gk', text: 'Ø­Ø§Ø±Ø³ Ù…Ø±Ù…Ù‰ ğŸ§¤' },
                { id: 'defender', text: 'Ù…Ø¯Ø§ÙØ¹ (CB/LB/RB) ğŸ›¡ï¸' },
                { id: 'midfielder', text: 'Ù„Ø§Ø¹Ø¨ ÙˆØ³Ø· (CM/CAM/CDM) ğŸ¯' },
                { id: 'forward', text: 'Ù…Ù‡Ø§Ø¬Ù… (ST/RW/LW) âš¡' },
                { id: 'jersey_10', text: 'Ø±Ù‚Ù… 10 ğŸ‘•' },
                { id: 'jersey_7', text: 'Ø±Ù‚Ù… 7 ğŸ‘•' },
                { id: 'jersey_9', text: 'Ø±Ù‚Ù… 9 ğŸ‘•' },
                { id: 'jersey_1', text: 'Ø±Ù‚Ù… 1 ğŸ‘•' },
                { id: 'captain', text: 'ÙƒØ§Ø¨ØªÙ† Ù…Ù†ØªØ®Ø¨ Ø¨Ù„Ø§Ø¯Ù‡ Â©' },
                { id: 'bald', text: 'Ø£ØµÙ„Ø¹ ğŸ‘¨â€ğŸ¦²' },
                { id: 'long_hair', text: 'Ø´Ø¹Ø±Ù‡ Ø·ÙˆÙŠÙ„ ğŸ¦' },
                { id: 'siblings', text: 'Ù„Ø¯ÙŠÙ‡ Ø£Ø® Ù„Ø§Ø¹Ø¨ ÙƒØ±Ø© ğŸ‘¬' },
                { id: 'father_player', text: 'ÙˆØ§Ù„Ø¯Ù‡ ÙƒØ§Ù† Ù„Ø§Ø¹Ø¨ ÙƒØ±Ø© ğŸ‘¨â€ğŸ‘¦' }
            ]
        };

        // --- Globals ---
        window.myName = localStorage.getItem('heka_global_player_name') || "";
        window.myRoomId = null;
        window.myPlayerId = null; // 'X' or 'O' in online mode context? No, usually host/joiner. Let's use 'X' or 'O' as role later.
        window.isOnline = false;

        // Game State (Shared)
        let localState = {
            board: Array(9).fill(null),
            cells: Array(9).fill(null),
            turn: 'X',
            timer: 45,
            history: [],
            activeRows: [],
            activeCols: [],
            p1Name: 'Player 1',
            p2Name: 'Player 2',
            myRole: null // 'X' or 'O'
        };

        let timerInterval = null;

        // --- Basic UI Ops ---
        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            setTimeout(() => document.getElementById(id).classList.add('active'), 100);
        };

        // --- Offline Only Wrappers ---
        window.startOfflineSetup = () => {
            window.isOnline = false;
            // Simplify: Skip setup screen, use defaults
            localState.p1Name = localStorage.getItem('heka_username') || "Player 1";
            localState.p2Name = "Player 2";
            localState.myRole = 'BOTH';

            document.getElementById('disp-p1').innerText = localState.p1Name;
            document.getElementById('disp-p2').innerText = localState.p2Name;

            initGameConfig();
            renderGrid();
            initGameConfig();
            renderGrid();
            // resetTimer(30);
            updateTurnUI();

            document.getElementById('host-controls').style.display = 'block'; // Offline always has controls
            updateTurnUI();

            window.showScreen('screen-game');
        };

        window.startGameOffline = () => {
            localState.p1Name = document.getElementById('p1-name').value || 'Player 1';
            localState.p2Name = document.getElementById('p2-name').value || 'Player 2';
            localState.myRole = 'BOTH'; // Offline controls both

            document.getElementById('disp-p1').innerText = localState.p1Name;
            document.getElementById('disp-p2').innerText = localState.p2Name;

            initGameConfig(); // Pick random rows
            renderGrid();
            initGameConfig(); // Pick random rows
            renderGrid();
            // resetTimer(45);
            updateTurnUI();

            document.getElementById('host-controls').style.display = 'block'; // Offline always has controls
            updateTurnUI();

            window.showScreen('screen-game');
        };

        // --- Online Logic ---
        window.createOnlineRoom = () => {
            if (!window.myName) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            window.myRoomId = roomId;
            window.myPlayerId = "host";
            window.isOnline = true;
            localState.myRole = 'X'; // Host is X

            // Initial Game State
            const startRows = getRandom(challenges.rows, 3);
            const startCols = getRandom(challenges.cols, 3);

            set(ref(db, `football_rooms/${roomId}`), {
                status: 'waiting',
                p1: { name: window.myName, role: 'X' },
                activeRows: startRows,
                activeCols: startCols,
                board: Array(9).fill(null),
                cells: Array(9).fill(null),
                turn: 'X'
                // timer: 45 Removed
            });

            enterOnlineLobby(roomId);
        };

        window.joinOnlineRoom = () => {
            const code = document.getElementById('room-code-input').value;
            if (!code) return alert("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©");
            window.myRoomId = code;
            window.myPlayerId = "joiner";
            window.isOnline = true;

            get(ref(db, `football_rooms/${code}`)).then(snap => {
                if (snap.exists()) {
                    // Update P2
                    update(ref(db, `football_rooms/${code}`), {
                        status: 'playing',
                        p2: { name: window.myName, role: 'O' }
                    });
                    localState.myRole = 'O'; // Joiner is O
                    enterOnlineLobby(code);
                } else {
                    alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
                }
            });
        };

        function enterOnlineLobby(roomId) {
            window.showScreen('screen-online-lobby');
            document.getElementById('lobby-code').innerText = roomId;

            // Listen to updates
            onValue(ref(db, `football_rooms/${roomId}`), (snap) => {
                const data = snap.val();
                if (!data) return;

                // Update Lobby UI always
                const p1 = data.p1 ? data.p1.name : '...';
                const p2 = data.p2 ? data.p2.name : '...';
                document.getElementById('lobby-p1').innerText = p1;
                document.getElementById('lobby-p2').innerText = p2;

                if (data.status === 'waiting') {
                    document.getElementById('lobby-status').innerText = data.p2 ? "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¶ÙŠÙ..." : "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ...";
                    if (window.myPlayerId === 'host' && data.p2 && document.getElementById('screen-online-lobby').classList.contains('active')) {
                        // Auto start or show button? Scrip logic auto-starts on join in joinRoom, let's keep it simple.
                        // Actually joinRoom sets status to 'playing'.
                    }
                }

                if (data.status === 'playing') {
                    // Sync State
                    localState.board = data.board ? (Array.isArray(data.board) ? data.board : Object.assign(Array(9).fill(null), data.board)) : Array(9).fill(null);
                    localState.cells = data.cells ? (Array.isArray(data.cells) ? data.cells : Object.assign(Array(9).fill(null), data.cells)) : Array(9).fill(null);
                    localState.turn = data.turn;
                    localState.activeRows = data.activeRows;
                    localState.activeCols = data.activeCols;
                    localState.p1Name = p1;
                    localState.p2Name = p2;

                    // Render
                    document.getElementById('disp-p1').innerText = localState.p1Name;
                    document.getElementById('disp-p2').innerText = localState.p2Name;

                    renderGrid();
                    updateTurnUI();

                    // If I am not active screen yet, go there
                    if (!document.getElementById('screen-game').classList.contains('active')) {
                        window.showScreen('screen-game');

                        // Show controls if Host
                        if (window.myPlayerId === 'host') {
                            document.getElementById('host-controls').style.display = 'block';
                        } else {
                            document.getElementById('host-controls').style.display = 'none';
                        }
                    }

                    // Handle Chat Removed
                }
            });
        }



        // --- Core Game Logic (Mixed) ---
        function initGameConfig() {
            localState.activeRows = getRandom(challenges.rows, 3);
            localState.activeCols = getRandom(challenges.cols, 3);
            localState.board = Array(9).fill(null);
            localState.cells = Array(9).fill(null);
            localState.turn = 'X';
            localState.history = [];
        }

        function getRandom(arr, n) {
            const shuffled = [...arr].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, n);
        }

        // RENDER GRID (Updated - Allow Cell Stealing)
        function renderGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = '';

            // Header Icon
            const tl = document.createElement('div');
            tl.className = 'cell header-cell';
            tl.innerHTML = 'âš½';
            grid.appendChild(tl);

            // Cols Headers
            localState.activeCols.forEach(col => {
                const cel = document.createElement('div');
                cel.className = 'cell header-cell';
                cel.style.flexDirection = 'column';
                cel.style.gap = '5px';
                cel.style.padding = '5px';
                if (col.img) {
                    cel.innerHTML = `<img src="${col.img}" style="width:40px; height:40px; object-fit:contain;"> <span style="font-size:0.9rem; font-weight:bold; line-height:1.2;">${col.text}</span>`;
                } else {
                    cel.innerText = col.text;
                    cel.style.fontSize = '0.9rem';
                    cel.style.fontWeight = 'bold';
                }
                grid.appendChild(cel);
            });

            // Rows + Cells
            localState.activeRows.forEach((row, rIdx) => {
                const rh = document.createElement('div');
                rh.className = 'cell header-cell';
                rh.style.flexDirection = 'column';
                rh.style.gap = '5px';
                rh.style.padding = '5px';
                if (row.img) {
                    rh.innerHTML = `<img src="${row.img}" style="width:40px; height:40px; object-fit:contain;"> <span style="font-size:0.9rem; font-weight:bold; line-height:1.2;">${row.text}</span>`;
                } else {
                    rh.innerText = row.text;
                    rh.style.fontSize = '0.9rem';
                    rh.style.fontWeight = 'bold';
                }
                grid.appendChild(rh);

                for (let cIdx = 0; cIdx < 3; cIdx++) {
                    const cellIdx = (rIdx * 3) + cIdx;
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'cell game-cell';

                    if (localState.cells[cellIdx]) {
                        const data = localState.cells[cellIdx];
                        // Keep cursor as pointer to allow stealing
                        cellDiv.style.cursor = 'pointer';
                        cellDiv.classList.add('taken');
                        cellDiv.classList.add(data.p === 'X' ? 'taken-x' : 'taken-o');

                        // Show name if exists, else just mark
                        let content = `<div class="player-mark">${data.p}</div>`;
                        if (data.name) content += `<div class="player-name-label">${data.name}</div>`;
                        cellDiv.innerHTML = content;
                    }

                    // ALL cells are now clickable - allow stealing!
                    cellDiv.onclick = () => handleCellClick(cellIdx, row, localState.activeCols[cIdx]);

                    grid.appendChild(cellDiv);
                }
            });
        }

        let selectedCellIdx = null;

        function handleCellClick(idx, row, col) {
            // Permission Check (Online)
            if (window.isOnline) {
                if (localState.turn !== localState.myRole) return; // Not my turn
            }

            // REMOVED: if (localState.cells[idx]) return;
            // Now we allow clicking on already-filled cells to "steal" them!

            selectedCellIdx = idx;

            // OFFLINE: Immediate Move
            if (!window.isOnline) {
                submitMove(null, true); // No name needed
                return;
            }

            // ONLINE: Show Modal (still need validation? User said simple offline, implied online simplified too? 
            // "In offline... fill with X or O... say voice". 
            // "Undo remove mark in offline AND online".
            // Let's keep modal for Online for clarity/verification, as voice isn't guaranteed online.
            // But if user insists on simplified, I'll stick to Online Modal for now as specific request was "First in offline...".

            document.getElementById('modal-criteria').innerText = `Ù…Ø·Ù„ÙˆØ¨ Ù„Ø§Ø¹Ø¨: ${row.text} + ${col.text}`;
            document.getElementById('player-input').value = '';
            document.getElementById('input-modal').style.display = 'flex';
            document.getElementById('player-input').focus();
        }

        window.closeModal = () => {
            document.getElementById('input-modal').style.display = 'none';
        };

        window.submitMove = (overrideName = null, isOfflineSimple = false) => {
            try {
                let name = overrideName;

                if (!isOfflineSimple && !name) {
                    name = document.getElementById('player-input').value.trim();
                    if (!name) name = "---";
                }

                if (selectedCellIdx === null) {
                    console.error("No cell selected");
                    closeModal();
                    return;
                }

                // Capture state for Undo
                const snapshot = {
                    board: [...localState.board],
                    cells: [...localState.cells],
                    turn: localState.turn,
                    timer: localState.timer
                };
                localState.history.push(snapshot);


                // Update Local (Optimistic)
                localState.cells[selectedCellIdx] = { p: localState.turn, name: name };
                localState.board[selectedCellIdx] = localState.turn;

                // Push to Firebase if online
                if (window.isOnline) {
                    if (!window.myRoomId) {
                        alert("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù ØºØ±ÙØ©!");
                        return;
                    }

                    const nextTurn = localState.turn === 'X' ? 'O' : 'X';
                    const roomUpdates = {};
                    roomUpdates[`cells/${selectedCellIdx}`] = { p: localState.turn, name: name };
                    roomUpdates[`board/${selectedCellIdx}`] = localState.turn;
                    roomUpdates[`turn`] = nextTurn;

                    update(ref(db, `football_rooms/${window.myRoomId}`), roomUpdates)
                        .catch(err => {
                            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + err.message);
                            console.error(err);
                        });
                } else {
                    // Offline Logic
                    localState.turn = localState.turn === 'X' ? 'O' : 'X';
                    // resetTimer(30);
                    renderGrid();
                    updateTurnUI();
                }

                closeModal();
                checkWin();
            } catch (e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: " + e.message);
                console.error(e);
            }
        };

        window.undoMove = () => {
            if (localState.history.length === 0) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§");

            // For Online: Can only undo if it is currently NOT my turn (meaning I just played)
            // AND the previous move was mine.
            // Or simpler: Just revert the last history state.

            const last = localState.history.pop();

            if (window.isOnline) {
                // Check if the move we are undoing matches the current state (sanity check)
                // If opponent played after us, undoing might be messy.
                // "Undo removes mark". 
                // If localState.turn != myRole, it means I just played (or opponent is thinking).
                // If I play, turn becomes Opponent.
                // So if turn is Opponent, I can Undo?
                // What if Opponent played? Then turn is Mine. 
                // If turn is Mine, I can Undo Opponent's move? No.
                // Assuming Cooperative play or "Undo" = "Take back my last mistake".
                // Let's implement global Undo: Revert the game state to `last`.

                const updates = {};
                updates[`football_rooms/${window.myRoomId}/board`] = last.board;
                updates[`football_rooms/${window.myRoomId}/cells`] = last.cells;
                updates[`football_rooms/${window.myRoomId}/turn`] = last.turn;
                update(ref(db), updates);

                // Local state will update via onValue
            } else {
                localState.board = last.board;
                localState.cells = last.cells;
                localState.turn = last.turn;
                // resetTimer(30); // Reset timer on undo
                renderGrid();
                updateTurnUI();
            }
        };

        // --- Helpers ---
        function updateTurnUI() {
            if (localState.turn === 'X') {
                document.getElementById('badge-x').classList.add('active');
                document.getElementById('badge-o').classList.remove('active');
            } else {
                document.getElementById('badge-x').classList.remove('active');
                document.getElementById('badge-o').classList.add('active');
            }
        }

        window.forceSkipTurn = () => {
            const nextTurn = localState.turn === 'X' ? 'O' : 'X';
            if (window.isOnline) {
                if (window.myPlayerId !== 'host') return;
                const updates = {};
                updates[`football_rooms/${window.myRoomId}/turn`] = nextTurn;
                update(ref(db), updates);
            } else {
                localState.turn = nextTurn;
                renderGrid();
                updateTurnUI();
            }
        };

        // window.toggleTimer ... REMOVED
        // window.resetTimerManual ... REMOVED
        // function resetTimer(secs) ... REMOVED
        // function updateTimerDisp() ... REMOVED

        window.resetGame = () => {
            if (window.isOnline) {
                if (window.myPlayerId !== 'host') return alert("ÙÙ‚Ø· Ø§Ù„Ù…Ø¶ÙŠÙ (Ø§Ù„Ù„Ø§Ø¹Ø¨ 1) ÙŠÙ…ÙƒÙ†Ù‡ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª ÙˆØ¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©");
                if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª ÙˆØ¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ")) return;

                const newRows = getRandom(challenges.rows, 3);
                const newCols = getRandom(challenges.cols, 3);

                const updates = {};
                updates[`football_rooms/${window.myRoomId}/board`] = Array(9).fill(null);
                updates[`football_rooms/${window.myRoomId}/cells`] = Array(9).fill(null);
                updates[`football_rooms/${window.myRoomId}/turn`] = 'X';
                updates[`football_rooms/${window.myRoomId}/activeRows`] = newRows;
                updates[`football_rooms/${window.myRoomId}/activeCols`] = newCols;

                update(ref(db), updates);
            } else {
                if (confirm("Ø¥Ø¹Ø§Ø¯Ø©ØŸ")) window.startGameOffline();
            }
        };

        // --- Helpers ---




        function checkWin() {
            const wins = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
            let winner = null;
            for (let w of wins) {
                const b = localState.board;
                if (b[w[0]] && b[w[0]] === b[w[1]] && b[w[0]] === b[w[2]]) {
                    winner = b[w[0]];
                    break;
                }
            }
            if (winner) {
                setTimeout(() => alert(`Ø§Ù„ÙØ§Ø¦Ø² ${winner}!`), 100);
            }
        }

        // Expose to window for UI onclicks
    </script>

</body>

</html>